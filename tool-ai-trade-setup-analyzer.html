<!DOCTYPE html>
<html lang="en" prefix="og: https://ogp.me/ns#">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-N0Y2LBMRSW"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-N0Y2LBMRSW');
    </script>
    <meta charset="UTF-8">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/png" sizes="96x96" href="favicon-96.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    
    <title>AI Trade Setup Analyzer - Educational Chart Analysis Tool with Gemini Vision | BroBillionaire</title>
    <meta name="description" content="Get AI-powered trade setup analysis using Google Gemini Vision (FREE). Upload chart screenshots for professional-grade technical analysis, multiple targets, position sizing, risk-reward calculations, and actionable trade ideas in seconds.">
    <meta name="keywords" content="AI trade analyzer, GPT-4 trading, AI chart analysis, automated technical analysis, trade setup scanner, AI trading assistant, stock chart analyzer, forex AI analysis, crypto AI trading, swing trade AI, position sizing calculator, risk reward ratio">
    <link rel="canonical" href="https://brobillionaire.com/tool-ai-trade-setup-analyzer.html">
    
    <!-- Open Graph -->
    <meta property="og:title" content="AI Trade Setup Analyzer - Smart Chart Analysis with Gemini Vision (FREE)">
    <meta property="og:description" content="Get AI-powered trade setup analysis using Google Gemini. Upload charts and receive professional technical analysis with position sizing instantly.">
    <meta property="og:url" content="https://brobillionaire.com/tool-ai-trade-setup-analyzer.html">
    <meta property="og:image" content="https://brobillionaire.com/og-ai-analyzer.jpg">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="BroBillionaire">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="AI Trade Setup Analyzer - Gemini Vision Powered (FREE)">
    <meta name="twitter:description" content="Upload your trading charts and get instant AI analysis with entry, multiple targets, position sizing, and risk management.">
    
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Playfair+Display:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- JSON-LD Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "AI Trade Setup Analyzer",
        "description": "AI-powered trade setup analysis tool using Google Gemini Vision for professional-grade chart analysis with position sizing and risk management",
        "url": "https://brobillionaire.com/tool-ai-trade-setup-analyzer.html",
        "applicationCategory": "FinanceApplication",
        "operatingSystem": "Any",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD"
        },
        "creator": {
            "@type": "Organization",
            "name": "BroBillionaire"
        }
    }
    </script>
    
    <style>
        :root {
            --gold: #C9A227;
            --gold-light: #E8D5A3;
            --gold-dark: #A68B1E;
            --bg-dark: #0a0a0a;
            --bg-card: #1a1a1a;
            --bg-input: #0d0d0d;
            --green: #22c55e;
            --green-light: #4ade80;
            --red: #ef4444;
            --red-light: #f87171;
            --orange: #f59e0b;
            --blue: #3b82f6;
            --purple: #8b5cf6;
        }
        
        .ai-analyzer-container { max-width: 1500px; margin: 0 auto; padding: 40px 20px; }
        
        .ai-header { text-align: center; margin-bottom: 50px; position: relative; }
        .ai-header::before { content: ''; position: absolute; top: -20px; left: 50%; transform: translateX(-50%); width: 150px; height: 3px; background: linear-gradient(90deg, transparent, var(--gold), transparent); }
        
        .ai-title { font-family: 'Playfair Display', serif; font-size: 3.2rem; background: linear-gradient(135deg, var(--gold) 0%, var(--gold-light) 50%, var(--gold) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 15px; text-shadow: none; }
        
        .ai-badge { display: inline-flex; align-items: center; gap: 10px; background: linear-gradient(135deg, rgba(201,162,39,0.2) 0%, rgba(201,162,39,0.1) 100%); border: 1px solid var(--gold); color: var(--gold); padding: 12px 28px; border-radius: 50px; font-size: 0.95rem; font-weight: 600; margin-bottom: 20px; }
        .ai-badge .pulse { width: 10px; height: 10px; background: var(--green); border-radius: 50%; animation: pulse 2s infinite; box-shadow: 0 0 10px var(--green); }
        @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.3); } }
        
        .ai-subtitle { color: #888; font-size: 1.15rem; max-width: 800px; margin: 0 auto; line-height: 1.9; }
        
        .feature-pills { display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; margin-top: 25px; }
        .feature-pill { background: rgba(201,162,39,0.1); border: 1px solid rgba(201,162,39,0.3); color: var(--gold-light); padding: 8px 18px; border-radius: 25px; font-size: 0.85rem; font-weight: 500; display: flex; align-items: center; gap: 6px; }
        .feature-pill i { font-size: 0.9rem; }
        
        .main-grid { display: grid; grid-template-columns: 480px 1fr; gap: 35px; }
        
        .input-section { background: linear-gradient(145deg, var(--bg-card) 0%, var(--bg-dark) 100%); border-radius: 24px; padding: 35px; border: 1px solid #2a2a2a; position: relative; overflow: hidden; height: fit-content; position: sticky; top: 20px; }
        .input-section::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, var(--gold), var(--gold-light), var(--gold)); }
        
        .section-title { font-family: 'Playfair Display', serif; font-size: 1.5rem; color: var(--gold); margin-bottom: 25px; display: flex; align-items: center; gap: 12px; }
        .section-title i { font-size: 1.3rem; }
        
        /* Upload Zone */
        .upload-zone { border: 2px dashed #3a3a3a; border-radius: 20px; padding: 45px 30px; text-align: center; transition: all 0.3s ease; cursor: pointer; background: rgba(0,0,0,0.4); position: relative; overflow: hidden; }
        .upload-zone:hover { border-color: var(--gold); background: rgba(201,162,39,0.05); }
        .upload-zone.dragover { border-color: var(--gold); background: rgba(201,162,39,0.1); transform: scale(1.02); box-shadow: 0 0 30px rgba(201,162,39,0.2); }
        .upload-zone.has-image { padding: 20px; }
        .upload-icon { font-size: 3.5rem; color: #3a3a3a; margin-bottom: 18px; transition: all 0.3s; }
        .upload-zone:hover .upload-icon { color: var(--gold); transform: scale(1.1) translateY(-5px); }
        .upload-text { color: #888; font-size: 1.05rem; margin-bottom: 8px; }
        .upload-hint { color: #555; font-size: 0.85rem; }
        .upload-preview { max-width: 100%; max-height: 250px; border-radius: 14px; display: none; margin-bottom: 15px; box-shadow: 0 15px 40px rgba(0,0,0,0.6); }
        .upload-zone.has-image .upload-preview { display: block; margin: 0 auto; }
        .upload-zone.has-image .upload-icon, .upload-zone.has-image .upload-text, .upload-zone.has-image .upload-hint { display: none; }
        .clear-image { position: absolute; top: 10px; right: 10px; background: rgba(239,68,68,0.9); color: #fff; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; display: none; font-size: 0.9rem; }
        .upload-zone.has-image .clear-image { display: flex; align-items: center; justify-content: center; }
        
        /* Form Fields */
        .form-group { margin-top: 22px; }
        .form-label { color: var(--gold); font-weight: 600; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; font-size: 0.92rem; }
        .form-label i { font-size: 0.9rem; opacity: 0.8; }
        
        .form-select, .form-input, .form-textarea { width: 100%; padding: 14px 16px; background: var(--bg-input); border: 2px solid #2a2a2a; border-radius: 12px; color: #fff; font-size: 0.95rem; transition: all 0.3s; font-family: inherit; }
        .form-select:focus, .form-input:focus, .form-textarea:focus { outline: none; border-color: var(--gold); box-shadow: 0 0 25px rgba(201,162,39,0.15); }
        .form-select option { background: var(--bg-card); color: #fff; }
        .form-textarea { min-height: 100px; resize: vertical; line-height: 1.6; }
        
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        .input-group { position: relative; }
        .input-prefix { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--gold); font-weight: 600; font-size: 0.95rem; }
        .input-group .form-input { padding-left: 35px; }
        
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .checkbox-item { display: flex; align-items: center; gap: 6px; background: var(--bg-input); padding: 8px 14px; border-radius: 8px; border: 1px solid #2a2a2a; cursor: pointer; transition: all 0.3s; font-size: 0.88rem; }
        .checkbox-item:hover { border-color: var(--gold); }
        .checkbox-item.checked { background: rgba(201,162,39,0.15); border-color: var(--gold); }
        .checkbox-item input { display: none; }
        .checkbox-item span { color: #888; transition: color 0.3s; }
        .checkbox-item.checked span { color: var(--gold); }
        
        /* Trading Style Selector */
        .style-selector { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
        .style-option { padding: 12px 10px; background: var(--bg-input); border: 2px solid #2a2a2a; border-radius: 10px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .style-option:hover { border-color: #4a4a4a; }
        .style-option.selected { border-color: var(--gold); background: rgba(201,162,39,0.1); }
        .style-option-icon { font-size: 1.5rem; margin-bottom: 5px; }
        .style-option-name { color: #999; font-size: 0.85rem; font-weight: 600; }
        .style-option.selected .style-option-name { color: var(--gold); }
        
        /* Analyze Button */
        .analyze-btn { width: 100%; margin-top: 28px; padding: 18px 30px; background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%); border: none; border-radius: 14px; color: #000; font-size: 1.15rem; font-weight: 700; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 12px; position: relative; overflow: hidden; text-transform: uppercase; letter-spacing: 1px; }
        .analyze-btn::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent); transition: left 0.6s; }
        .analyze-btn:hover::before { left: 100%; }
        .analyze-btn:hover { transform: translateY(-3px); box-shadow: 0 15px 40px rgba(201,162,39,0.4); }
        .analyze-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .analyze-btn .spinner { display: none; width: 24px; height: 24px; border: 3px solid rgba(0,0,0,0.2); border-top-color: #000; border-radius: 50%; animation: spin 0.8s linear infinite; }
        .analyze-btn.loading .spinner { display: block; }
        .analyze-btn.loading .btn-text { display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Results Section */
        .results-section { display: none; }
        .results-section.visible { display: block; animation: fadeSlideIn 0.6s ease; }
        @keyframes fadeSlideIn { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        
        .results-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 25px; }
        .results-title { font-family: 'Playfair Display', serif; font-size: 1.8rem; color: var(--gold); display: flex; align-items: center; gap: 12px; }
        .results-actions { display: flex; gap: 10px; }
        
        /* Signal Box */
        .signal-box { background: linear-gradient(135deg, var(--bg-dark) 0%, #151515 100%); border-radius: 20px; padding: 30px; margin-bottom: 25px; border: 2px solid; position: relative; overflow: hidden; }
        .signal-box.bullish { border-color: var(--green); }
        .signal-box.bearish { border-color: var(--red); }
        .signal-box.neutral { border-color: var(--orange); }
        .signal-box::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 5px; }
        .signal-box.bullish::before { background: linear-gradient(90deg, var(--green), var(--green-light)); }
        .signal-box.bearish::before { background: linear-gradient(90deg, var(--red), var(--red-light)); }
        .signal-box.neutral::before { background: linear-gradient(90deg, var(--orange), #fbbf24); }
        
        .signal-main { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 25px; align-items: center; }
        .signal-primary { text-align: center; }
        .signal-label { color: #666; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 8px; }
        .signal-value { font-size: 2.8rem; font-weight: 800; display: flex; align-items: center; justify-content: center; gap: 12px; }
        .signal-value.bullish { color: var(--green); }
        .signal-value.bearish { color: var(--red); }
        .signal-value.neutral { color: var(--orange); }
        .signal-value i { font-size: 2rem; }
        
        .confidence-section { text-align: center; }
        .confidence-circle { width: 100px; height: 100px; border-radius: 50%; background: conic-gradient(var(--gold) 0deg, var(--gold) calc(var(--confidence) * 3.6deg), #2a2a2a calc(var(--confidence) * 3.6deg)); display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; position: relative; }
        .confidence-circle::before { content: ''; position: absolute; width: 80px; height: 80px; background: var(--bg-dark); border-radius: 50%; }
        .confidence-number { position: relative; z-index: 1; font-size: 1.8rem; font-weight: 700; color: #fff; }
        
        .trade-type-badge { text-align: center; }
        .trade-badge { display: inline-block; padding: 12px 25px; border-radius: 30px; font-weight: 700; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; }
        .trade-badge.long { background: rgba(34,197,94,0.2); color: var(--green); border: 2px solid var(--green); }
        .trade-badge.short { background: rgba(239,68,68,0.2); color: var(--red); border: 2px solid var(--red); }
        .trade-badge.wait { background: rgba(245,158,11,0.2); color: var(--orange); border: 2px solid var(--orange); }
        
        /* Levels Section */
        .levels-section { background: var(--bg-card); border-radius: 20px; padding: 30px; margin-bottom: 25px; border: 1px solid #2a2a2a; }
        .levels-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 25px; }
        .levels-title { color: var(--gold); font-weight: 700; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
        
        .levels-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; }
        .level-card { background: var(--bg-dark); border-radius: 14px; padding: 20px 15px; text-align: center; border: 1px solid #2a2a2a; position: relative; overflow: hidden; }
        .level-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; }
        .level-card.entry::before { background: var(--gold); }
        .level-card.target1::before { background: var(--green); }
        .level-card.target2::before { background: #10b981; }
        .level-card.target3::before { background: #059669; }
        .level-card.stop::before { background: var(--red); }
        .level-label { color: #666; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .level-value { font-size: 1.3rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
        .level-value.entry { color: var(--gold); }
        .level-value.target { color: var(--green); }
        .level-value.stop { color: var(--red); }
        .level-percent { font-size: 0.8rem; color: #666; margin-top: 5px; }
        .level-percent.positive { color: var(--green); }
        .level-percent.negative { color: var(--red); }
        
        /* Position Calculator */
        .position-calc { background: linear-gradient(135deg, rgba(201,162,39,0.1) 0%, rgba(201,162,39,0.05) 100%); border: 2px solid rgba(201,162,39,0.3); border-radius: 20px; padding: 30px; margin-bottom: 25px; }
        .position-calc-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 25px; }
        .position-calc-title { color: var(--gold); font-weight: 700; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
        .position-calc-title i { font-size: 1.1rem; }
        
        .capital-input-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 25px; }
        .capital-field { margin-bottom: 0; }
        .capital-field label { color: #888; font-size: 0.85rem; margin-bottom: 8px; display: block; }
        .capital-input { width: 100%; padding: 14px 16px; background: var(--bg-dark); border: 2px solid #3a3a3a; border-radius: 10px; color: #fff; font-size: 1rem; font-family: 'JetBrains Mono', monospace; }
        .capital-input:focus { outline: none; border-color: var(--gold); }
        
        .position-results { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .position-stat { background: var(--bg-dark); border-radius: 12px; padding: 18px; text-align: center; border: 1px solid #2a2a2a; }
        .position-stat-label { color: #666; font-size: 0.8rem; text-transform: uppercase; margin-bottom: 8px; }
        .position-stat-value { font-size: 1.5rem; font-weight: 700; color: #fff; font-family: 'JetBrains Mono', monospace; }
        .position-stat-value.gold { color: var(--gold); }
        .position-stat-value.green { color: var(--green); }
        .position-stat-value.red { color: var(--red); }
        .position-stat-sub { font-size: 0.75rem; color: #555; margin-top: 4px; }
        
        /* Analysis Cards Grid */
        .analysis-section { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 25px; }
        
        .analysis-card { background: var(--bg-card); border-radius: 16px; padding: 25px; border: 1px solid #2a2a2a; }
        .analysis-card-header { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .analysis-card-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; }
        .analysis-card-icon.pattern { background: rgba(139,92,246,0.2); color: var(--purple); }
        .analysis-card-icon.trend { background: rgba(59,130,246,0.2); color: var(--blue); }
        .analysis-card-icon.momentum { background: rgba(34,197,94,0.2); color: var(--green); }
        .analysis-card-icon.volume { background: rgba(245,158,11,0.2); color: var(--orange); }
        .analysis-card-title { color: #fff; font-weight: 600; font-size: 1rem; }
        .analysis-card-value { color: var(--gold); font-size: 1.6rem; font-weight: 700; margin-bottom: 5px; }
        .analysis-card-sub { color: #666; font-size: 0.85rem; }
        
        /* Key Metrics Row */
        .metrics-row { display: grid; grid-template-columns: repeat(6, 1fr); gap: 15px; margin-bottom: 25px; }
        .metric-card { background: var(--bg-card); border-radius: 14px; padding: 20px 15px; text-align: center; border: 1px solid #2a2a2a; overflow: hidden; }
        .metric-icon { font-size: 1.5rem; margin-bottom: 8px; }
        .metric-label { color: #666; font-size: 0.75rem; text-transform: uppercase; margin-bottom: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .metric-value { color: #fff; font-size: 1.1rem; font-weight: 700; word-break: break-word; line-height: 1.3; }
        
        /* Risk Reward Visual */
        .rr-visual { background: var(--bg-card); border-radius: 16px; padding: 25px; margin-bottom: 25px; border: 1px solid #2a2a2a; }
        .rr-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .rr-title { color: var(--gold); font-weight: 700; font-size: 1.1rem; }
        .rr-ratio { font-size: 2rem; font-weight: 800; color: #fff; }
        .rr-bar { display: flex; height: 40px; border-radius: 10px; overflow: hidden; margin-bottom: 15px; }
        .rr-risk { background: linear-gradient(90deg, var(--red), var(--red-light)); display: flex; align-items: center; justify-content: center; color: #fff; font-weight: 700; font-size: 0.9rem; }
        .rr-reward { background: linear-gradient(90deg, var(--green), var(--green-light)); display: flex; align-items: center; justify-content: center; color: #fff; font-weight: 700; font-size: 0.9rem; }
        .rr-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .rr-stat { text-align: center; padding: 15px; background: var(--bg-dark); border-radius: 10px; }
        .rr-stat-label { color: #666; font-size: 0.8rem; margin-bottom: 5px; }
        .rr-stat-value { font-size: 1.2rem; font-weight: 700; }
        
        /* Detailed Analysis */
        .detailed-analysis { background: var(--bg-card); border-radius: 16px; padding: 30px; border-left: 4px solid var(--gold); margin-bottom: 25px; }
        .detailed-analysis-header { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
        .detailed-analysis h4 { color: var(--gold); font-size: 1.2rem; margin: 0; }
        .detailed-analysis-content { color: #bbb; line-height: 1.9; font-size: 1rem; }
        .detailed-analysis-content p { margin-bottom: 15px; }
        .detailed-analysis-content strong { color: var(--gold); }
        .detailed-analysis-content ul { margin: 15px 0 15px 25px; }
        .detailed-analysis-content li { margin-bottom: 10px; }
        
        /* Indicators Section */
        .indicators-section { background: var(--bg-card); border-radius: 16px; padding: 25px; margin-bottom: 25px; border: 1px solid #2a2a2a; }
        .indicators-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .indicator-item { background: var(--bg-dark); border-radius: 12px; padding: 18px; text-align: center; }
        .indicator-name { color: #888; font-size: 0.85rem; margin-bottom: 8px; }
        .indicator-value { font-size: 1.1rem; font-weight: 600; }
        .indicator-signal { font-size: 0.8rem; margin-top: 5px; padding: 3px 10px; border-radius: 10px; display: inline-block; }
        .indicator-signal.buy { background: rgba(34,197,94,0.2); color: var(--green); }
        .indicator-signal.sell { background: rgba(239,68,68,0.2); color: var(--red); }
        .indicator-signal.neutral { background: rgba(245,158,11,0.2); color: var(--orange); }
        
        /* Trade Checklist */
        .checklist-section { background: var(--bg-card); border-radius: 16px; padding: 25px; margin-bottom: 25px; border: 1px solid #2a2a2a; }
        .checklist-title { color: var(--gold); font-weight: 700; font-size: 1.1rem; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .checklist-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .checklist-item { display: flex; align-items: center; gap: 12px; padding: 12px 15px; background: var(--bg-dark); border-radius: 10px; }
        .checklist-icon { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; }
        .checklist-icon.pass { background: rgba(34,197,94,0.2); color: var(--green); }
        .checklist-icon.fail { background: rgba(239,68,68,0.2); color: var(--red); }
        .checklist-icon.warn { background: rgba(245,158,11,0.2); color: var(--orange); }
        .checklist-text { color: #ccc; font-size: 0.9rem; flex: 1; }
        
        /* Risk Meter */
        .risk-meter { background: var(--bg-card); border-radius: 16px; padding: 25px; margin-bottom: 25px; border: 1px solid #2a2a2a; }
        .risk-meter-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .risk-meter-title { color: var(--gold); font-weight: 700; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }
        .risk-level-badge { padding: 6px 15px; border-radius: 20px; font-weight: 600; font-size: 0.85rem; }
        .risk-level-badge.low { background: rgba(34,197,94,0.2); color: var(--green); }
        .risk-level-badge.medium { background: rgba(245,158,11,0.2); color: var(--orange); }
        .risk-level-badge.high { background: rgba(239,68,68,0.2); color: var(--red); }
        .risk-scale { display: flex; height: 14px; border-radius: 7px; overflow: hidden; gap: 4px; }
        .risk-segment { flex: 1; transition: all 0.3s; border-radius: 3px; }
        .risk-segment:nth-child(1) { background: #22c55e; }
        .risk-segment:nth-child(2) { background: #84cc16; }
        .risk-segment:nth-child(3) { background: #eab308; }
        .risk-segment:nth-child(4) { background: #f97316; }
        .risk-segment:nth-child(5) { background: #ef4444; }
        .risk-segment.active { transform: scaleY(1.6); box-shadow: 0 0 15px currentColor; }
        .risk-labels { display: flex; justify-content: space-between; margin-top: 12px; }
        .risk-labels span { color: #555; font-size: 0.8rem; }
        
        /* Action Buttons */
        .action-buttons { display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; }
        .action-btn { flex: 1; min-width: 150px; padding: 15px 25px; border-radius: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.3s; border: none; font-size: 0.95rem; }
        .action-btn.primary { background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%); color: #000; }
        .action-btn.primary:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(201,162,39,0.3); }
        .action-btn.secondary { background: #2a2a2a; color: #fff; border: 1px solid #3a3a3a; }
        .action-btn.secondary:hover { background: #3a3a3a; }
        .action-btn.success { background: rgba(34,197,94,0.2); color: var(--green); border: 1px solid var(--green); }
        
        /* Disclaimer */
        .disclaimer { background: linear-gradient(135deg, rgba(239,68,68,0.1) 0%, rgba(239,68,68,0.05) 100%); border: 2px solid rgba(239,68,68,0.3); border-radius: 20px; padding: 30px; margin-top: 40px; }
        .disclaimer-header { display: flex; align-items: center; gap: 12px; margin-bottom: 15px; }
        .disclaimer-icon { width: 45px; height: 45px; background: rgba(239,68,68,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--red); font-size: 1.3rem; }
        .disclaimer-title { color: var(--red); font-weight: 700; font-size: 1.2rem; }
        .disclaimer p { color: #888; line-height: 1.8; font-size: 0.92rem; margin-bottom: 12px; }
        .disclaimer strong { color: #bbb; }
        
        /* Premium Badge */
        .premium-feature { position: absolute; top: 15px; right: 15px; background: linear-gradient(135deg, var(--gold) 0%, var(--gold-light) 100%); color: #000; padding: 6px 14px; border-radius: 20px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 5px; }
        
        /* Mobile Responsive */
        @media (max-width: 1200px) {
            .main-grid { grid-template-columns: 1fr; }
            .input-section { position: static; }
            .levels-grid { grid-template-columns: repeat(3, 1fr); }
            .metrics-row { grid-template-columns: repeat(3, 1fr); }
            .capital-input-row { grid-template-columns: 1fr 1fr; }
            .position-results { grid-template-columns: repeat(2, 1fr); }
        }
        
        @media (max-width: 768px) {
            .ai-analyzer-container { padding: 20px 15px; }
            .ai-title { font-size: 2rem; }
            .ai-subtitle { font-size: 1rem; }
            .input-section { padding: 25px 20px; }
            .signal-main { grid-template-columns: 1fr; gap: 20px; }
            .levels-grid { grid-template-columns: 1fr 1fr; }
            .analysis-section { grid-template-columns: 1fr; }
            .metrics-row { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .metric-card { padding: 15px 10px; }
            .metric-icon { font-size: 1.2rem; margin-bottom: 5px; }
            .metric-label { font-size: 0.65rem; }
            .metric-value { font-size: 0.95rem; }
            .indicators-grid { grid-template-columns: repeat(2, 1fr); }
            .checklist-grid { grid-template-columns: 1fr; }
            .capital-input-row { grid-template-columns: 1fr; }
            .position-results { grid-template-columns: 1fr 1fr; }
            .rr-stats { grid-template-columns: 1fr; }
            .action-buttons { flex-direction: column; }
            .form-row { grid-template-columns: 1fr; }
            .feature-pills { gap: 8px; }
            .feature-pill { font-size: 0.75rem; padding: 6px 12px; }
        }
        
        @media (max-width: 480px) {
            .metrics-row { grid-template-columns: repeat(2, 1fr); gap: 8px; }
            .metric-card { padding: 12px 8px; border-radius: 10px; }
            .metric-icon { font-size: 1rem; margin-bottom: 4px; }
            .metric-label { font-size: 0.6rem; letter-spacing: 0; }
            .metric-value { font-size: 0.85rem; }
        }
        
        /* Glow Effect */
        .glow { text-shadow: 0 0 20px rgba(201,162,39,0.4), 0 0 40px rgba(201,162,39,0.2); }
        
        /* Enable text selection for copy functionality */
        .results-section { user-select: text !important; -webkit-user-select: text !important; -moz-user-select: text !important; -ms-user-select: text !important; }
        .results-section * { user-select: text !important; -webkit-user-select: text !important; }
        .level-value, .signal-value, .indicator-value, .metric-value, .analysis-card-value, .detailed-analysis-content { cursor: text; }
        .level-value::selection, .signal-value::selection, .detailed-analysis-content::selection { background: rgba(201,162,39,0.4); color: #fff; }
        
        /* Copy button animation */
        .action-btn.primary.copied { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%) !important; }
        
        /* Disclaimer styling enhancements */
        .disclaimer { margin-bottom: 20px; }
        .disclaimer p { user-select: text; }
        
        /* New Enhanced Sections */
        .volatility-section { background: var(--bg-card); border-radius: 16px; padding: 25px; margin-bottom: 25px; border: 1px solid #2a2a2a; }
        .volatility-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .volatility-title { color: var(--gold); font-weight: 700; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }
        .volatility-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .volatility-item { background: var(--bg-dark); border-radius: 12px; padding: 18px; text-align: center; border: 1px solid #2a2a2a; }
        .volatility-label { color: #666; font-size: 0.8rem; text-transform: uppercase; margin-bottom: 8px; }
        .volatility-value { font-size: 1.3rem; font-weight: 700; }
        .volatility-value.high { color: var(--red); }
        .volatility-value.medium { color: var(--orange); }
        .volatility-value.low { color: var(--green); }
        
        /* P&L Scenarios */
        .pnl-scenarios { background: linear-gradient(135deg, rgba(59,130,246,0.1) 0%, rgba(59,130,246,0.05) 100%); border: 2px solid rgba(59,130,246,0.3); border-radius: 20px; padding: 30px; margin-bottom: 25px; }
        .pnl-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 25px; }
        .pnl-title { color: var(--blue); font-weight: 700; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
        .pnl-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .pnl-card { background: var(--bg-dark); border-radius: 14px; padding: 20px; text-align: center; border-left: 4px solid; }
        .pnl-card.best { border-color: var(--green); }
        .pnl-card.expected { border-color: var(--gold); }
        .pnl-card.partial { border-color: var(--orange); }
        .pnl-card.worst { border-color: var(--red); }
        .pnl-label { color: #666; font-size: 0.8rem; text-transform: uppercase; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .pnl-amount { font-size: 1.5rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; margin-bottom: 5px; }
        .pnl-amount.positive { color: var(--green); }
        .pnl-amount.negative { color: var(--red); }
        .pnl-percent { font-size: 0.85rem; color: #888; }
        .pnl-prob { font-size: 0.75rem; color: #555; margin-top: 5px; }
        
        /* Exit Strategy Section */
        .exit-strategy-section { background: var(--bg-card); border-radius: 16px; padding: 25px; margin-bottom: 25px; border: 1px solid #2a2a2a; }
        .exit-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .exit-title { color: var(--gold); font-weight: 700; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }
        .exit-timeline { display: flex; align-items: center; gap: 10px; position: relative; padding: 20px 0; }
        .exit-step { flex: 1; text-align: center; position: relative; }
        .exit-step::before { content: ''; position: absolute; top: 25px; left: 50%; right: -50%; height: 3px; background: #2a2a2a; z-index: 0; }
        .exit-step:last-child::before { display: none; }
        .exit-dot { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; position: relative; z-index: 1; font-weight: 700; }
        .exit-dot.entry { background: rgba(201,162,39,0.2); border: 2px solid var(--gold); color: var(--gold); }
        .exit-dot.t1 { background: rgba(34,197,94,0.2); border: 2px solid var(--green); color: var(--green); }
        .exit-dot.t2 { background: rgba(16,185,129,0.2); border: 2px solid #10b981; color: #10b981; }
        .exit-dot.t3 { background: rgba(5,150,105,0.2); border: 2px solid #059669; color: #059669; }
        .exit-dot.sl { background: rgba(239,68,68,0.2); border: 2px solid var(--red); color: var(--red); }
        .exit-info { color: #888; font-size: 0.85rem; }
        .exit-info strong { display: block; color: #fff; font-size: 1rem; margin-bottom: 3px; }
        
        /* Advanced Metrics Grid */
        .advanced-metrics { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px; }
        .adv-metric { background: var(--bg-card); border-radius: 14px; padding: 20px; border: 1px solid #2a2a2a; }
        .adv-metric-header { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }
        .adv-metric-icon { width: 35px; height: 35px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1rem; }
        .adv-metric-icon.kelly { background: rgba(139,92,246,0.2); color: var(--purple); }
        .adv-metric-icon.ev { background: rgba(59,130,246,0.2); color: var(--blue); }
        .adv-metric-icon.sharpe { background: rgba(34,197,94,0.2); color: var(--green); }
        .adv-metric-icon.drawdown { background: rgba(239,68,68,0.2); color: var(--red); }
        .adv-metric-name { color: #888; font-size: 0.85rem; }
        .adv-metric-value { font-size: 1.6rem; font-weight: 700; color: #fff; margin-bottom: 5px; }
        .adv-metric-sub { color: #555; font-size: 0.8rem; }
        
        /* Trade Timing Section */
        .timing-section { background: linear-gradient(135deg, rgba(245,158,11,0.1) 0%, rgba(245,158,11,0.05) 100%); border: 2px solid rgba(245,158,11,0.3); border-radius: 20px; padding: 30px; margin-bottom: 25px; }
        .timing-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .timing-title { color: var(--orange); font-weight: 700; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }
        .timing-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .timing-card { background: var(--bg-dark); border-radius: 12px; padding: 18px; text-align: center; }
        .timing-icon { font-size: 2rem; margin-bottom: 10px; }
        .timing-label { color: #666; font-size: 0.85rem; margin-bottom: 5px; }
        .timing-value { color: #fff; font-size: 1.1rem; font-weight: 600; }
        
        /* Cost Analysis */
        .cost-analysis { background: var(--bg-card); border-radius: 16px; padding: 25px; margin-bottom: 25px; border: 1px solid #2a2a2a; }
        .cost-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .cost-title { color: var(--gold); font-weight: 700; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }
        .cost-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; }
        .cost-item { background: var(--bg-dark); border-radius: 10px; padding: 15px; text-align: center; }
        .cost-label { color: #666; font-size: 0.75rem; text-transform: uppercase; margin-bottom: 6px; }
        .cost-value { color: var(--red); font-size: 1.1rem; font-weight: 600; font-family: 'JetBrains Mono', monospace; }
        .cost-total { background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); }
        .cost-total .cost-value { font-size: 1.3rem; }
        
        /* Best Trade Badge */
        .best-trade-badge { display: inline-flex; align-items: center; gap: 8px; background: linear-gradient(135deg, rgba(34,197,94,0.2) 0%, rgba(34,197,94,0.1) 100%); border: 2px solid var(--green); color: var(--green); padding: 8px 18px; border-radius: 30px; font-weight: 600; font-size: 0.9rem; }
        
        /* Live VIX indicator in results */
        .vix-live-badge { display: inline-flex; align-items: center; gap: 6px; font-size: 0.7rem; color: var(--green); }
        .vix-live-badge .live-dot { width: 6px; height: 6px; background: var(--green); border-radius: 50%; animation: pulse 1.5s ease-in-out infinite; }
        .vix-interpretation { font-size: 0.75rem; color: #888; margin-top: 4px; }
        
        /* Mobile adjustments for new sections */
        @media (max-width: 1200px) {
            .volatility-grid { grid-template-columns: repeat(2, 1fr); }
            .pnl-grid { grid-template-columns: repeat(2, 1fr); }
            .advanced-metrics { grid-template-columns: repeat(2, 1fr); }
            .cost-grid { grid-template-columns: repeat(3, 1fr); }
        }
        @media (max-width: 768px) {
            .volatility-grid { grid-template-columns: 1fr 1fr; }
            .pnl-grid { grid-template-columns: 1fr; }
            .advanced-metrics { grid-template-columns: 1fr; }
            .timing-grid { grid-template-columns: 1fr; }
            .cost-grid { grid-template-columns: 1fr 1fr; }
            .exit-timeline { flex-direction: column; }
            .exit-step::before { display: none; }
        }
    </style>
</head>
<body>
    <div class="ai-analyzer-container">
        <!-- SEBI Compliance Top Banner -->
        <div style="background: linear-gradient(135deg, rgba(220,38,38,0.2) 0%, rgba(220,38,38,0.1) 100%); border: 2px solid #dc2626; border-radius: 12px; padding: 15px 20px; margin-bottom: 25px; text-align: center;">
            <p style="color: #ff6b6b; font-size: 0.9rem; margin: 0; line-height: 1.6;">
                <i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>
                <strong>IMPORTANT:</strong> This is an EDUCATIONAL tool only. NOT SEBI registered. NOT investment advice. Trading involves HIGH RISK - 9/10 F&O traders lose money. 
                <a href="#disclaimers" style="color: #fbbf24; text-decoration: underline;">Read Full Disclaimers ‚Üì</a>
            </p>
        </div>
        
        <!-- Header -->
        <div class="ai-header">
            <div class="ai-badge">
                <div class="pulse"></div>
                <i class="fas fa-robot"></i> Powered by Gemini AI (FREE Vision Analysis)
            </div>
            <h1 class="ai-title glow"><i class="fas fa-brain"></i> AI Trade Setup Analyzer</h1>
            <p class="ai-subtitle">Upload your chart screenshot and let our AI analyze patterns for <strong>educational purposes</strong>. Learn to identify key levels, understand position sizing concepts, and study institutional-grade technical analysis with multiple targets. <em>Not financial advice.</em></p>
            
            <div class="feature-pills">
                <div class="feature-pill"><i class="fas fa-bullseye"></i> Multiple Targets</div>
                <div class="feature-pill"><i class="fas fa-calculator"></i> Position Sizing</div>
                <div class="feature-pill"><i class="fas fa-balance-scale"></i> Risk:Reward</div>
                <div class="feature-pill"><i class="fas fa-chart-pie"></i> Pattern Detection</div>
                <div class="feature-pill"><i class="fas fa-tachometer-alt"></i> Momentum Analysis</div>
                <div class="feature-pill"><i class="fas fa-list-check"></i> Trade Checklist</div>
                <div class="feature-pill"><i class="fas fa-fire-flame-curved"></i> Live India VIX</div>
                <div class="feature-pill"><i class="fas fa-coins"></i> P&L Scenarios</div>
                <div class="feature-pill"><i class="fas fa-route"></i> Exit Strategy</div>
                <div class="feature-pill"><i class="fas fa-clock-rotate-left"></i> Time Analysis</div>
            </div>
        </div>
        
        <div class="main-grid">
            <!-- Input Section -->
            <div class="input-section">
                <span class="premium-feature"><i class="fas fa-crown"></i> Premium</span>
                <h2 class="section-title"><i class="fas fa-chart-line"></i> Upload Your Chart</h2>
                
                <div class="upload-zone" id="uploadZone">
                    <input type="file" id="chartInput" accept="image/*" style="display: none;">
                    <img class="upload-preview" id="uploadPreview" alt="Chart Preview">
                    <button class="clear-image" onclick="clearImage(event)"><i class="fas fa-times"></i></button>
                    <i class="fas fa-cloud-upload-alt upload-icon"></i>
                    <div class="upload-text">Drop your chart here, click to upload, or <strong style="color: var(--gold);">paste (Ctrl+V)</strong></div>
                    <div class="upload-hint">Supports PNG, JPG, JPEG ‚Ä¢ Max 20MB ‚Ä¢ TradingView, Zerodha, MT4 ‚Ä¢ <i class="fas fa-paste"></i> Paste from clipboard</div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-chart-bar"></i> Asset Type</label>
                        <select class="form-select" id="assetType">
                            <option value="stock">üìà Stock / Equity</option>
                            <option value="index" selected>üìä Index (NIFTY, BANKNIFTY)</option>
                            <option value="forex">üí± Forex / Currency</option>
                            <option value="crypto">‚Çø Cryptocurrency</option>
                            <option value="commodity">üõ¢Ô∏è Commodity</option>
                            <option value="options">üìâ Options / F&O</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-clock"></i> Timeframe</label>
                        <select class="form-select" id="timeframe">
                            <option value="1m">1 Min (Scalping)</option>
                            <option value="5m">5 Min (Intraday)</option>
                            <option value="15m" selected>15 Min (Day Trading)</option>
                            <option value="1h">1 Hour (Swing)</option>
                            <option value="4h">4 Hours (Position)</option>
                            <option value="1d">Daily (Swing)</option>
                            <option value="1w">Weekly (Investment)</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-user-tie"></i> Trading Style</label>
                    <div class="style-selector">
                        <div class="style-option" data-style="scalper" onclick="selectStyle(this)">
                            <div class="style-option-icon">‚ö°</div>
                            <div class="style-option-name">Scalper</div>
                        </div>
                        <div class="style-option selected" data-style="daytrader" onclick="selectStyle(this)">
                            <div class="style-option-icon">üìä</div>
                            <div class="style-option-name">Day Trader</div>
                        </div>
                        <div class="style-option" data-style="swing" onclick="selectStyle(this)">
                            <div class="style-option-icon">üéØ</div>
                            <div class="style-option-name">Swing Trader</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-bullseye"></i> Analysis Focus</label>
                    <div class="checkbox-group" id="focusGroup">
                        <div class="checkbox-item checked" data-value="patterns"><span>üìê Patterns</span></div>
                        <div class="checkbox-item checked" data-value="levels"><span>üéØ S/R Levels</span></div>
                        <div class="checkbox-item checked" data-value="trend"><span>üìà Trend</span></div>
                        <div class="checkbox-item checked" data-value="indicators"><span>üìä Indicators</span></div>
                        <div class="checkbox-item" data-value="volume"><span>üì∂ Volume</span></div>
                        <div class="checkbox-item" data-value="fibonacci"><span>üåÄ Fibonacci</span></div>
                        <div class="checkbox-item" data-value="candlestick"><span>üïØÔ∏è Candlesticks</span></div>
                        <div class="checkbox-item" data-value="divergence"><span>‚ÜîÔ∏è Divergence</span></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-wallet"></i> Your Trading Capital</label>
                    <div class="input-group">
                        <span class="input-prefix">‚Çπ</span>
                        <input type="number" class="form-input" id="capitalInput" placeholder="100000" value="100000">
                    </div>
                </div>
                
                <div class="form-group" style="background: rgba(201,162,39,0.1); padding: 15px; border-radius: 12px; border: 1px solid rgba(201,162,39,0.3);">
                    <label class="form-label" style="color: #f59e0b;"><i class="fas fa-tag"></i> Current Price (REQUIRED for accuracy)</label>
                    <div class="input-group">
                        <input type="number" class="form-input" id="referencePriceInput" placeholder="e.g., 55000" step="0.01" style="font-size: 1.1rem; font-weight: 600;">
                    </div>
                    <small style="color:#999; font-size:0.8rem; margin-top:5px; display:block;">Enter the current price from your chart. This ensures accurate targets. Look at the last candle or price line.</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-shield-alt"></i> Risk Per Trade (%)</label>
                    <select class="form-select" id="riskPercent">
                        <option value="0.5">0.5% (Conservative)</option>
                        <option value="1" selected>1% (Recommended)</option>
                        <option value="1.5">1.5% (Moderate)</option>
                        <option value="2">2% (Aggressive)</option>
                        <option value="3">3% (Very Aggressive)</option>
                    </select>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-percent"></i> Leverage / Margin</label>
                        <select class="form-select" id="leverageInput">
                            <option value="1">1x (No Leverage)</option>
                            <option value="2">2x (MIS/Intraday)</option>
                            <option value="3">3x</option>
                            <option value="5" selected>5x (F&O)</option>
                            <option value="10">10x</option>
                            <option value="20">20x (Forex/Crypto)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-building-columns"></i> Brokerage (per trade)</label>
                        <div class="input-group">
                            <span class="input-prefix">‚Çπ</span>
                            <input type="number" class="form-input" id="brokerageInput" placeholder="20" value="20">
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-sun"></i> Market Session</label>
                        <select class="form-select" id="marketSession">
                            <option value="pre">Pre-Market (9:00-9:15)</option>
                            <option value="opening">Opening (9:15-10:00)</option>
                            <option value="mid" selected>Mid-Session (10:00-2:30)</option>
                            <option value="closing">Closing (2:30-3:30)</option>
                            <option value="overnight">Overnight/Global</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-bolt"></i> Expected Volatility</label>
                        <select class="form-select" id="expectedVolatility">
                            <option value="low">Low (Quiet Day)</option>
                            <option value="normal" selected>Normal</option>
                            <option value="high">High (News/Events)</option>
                            <option value="extreme">Extreme (Expiry/Budget)</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-chart-line"></i> India VIX (Optional)</label>
                        <div class="input-group">
                            <input type="number" class="form-input" id="indiaVixInput" placeholder="e.g., 14.5" step="0.1" min="8" max="90">
                        </div>
                        <small style="color:#666; font-size:0.75rem;">Current India VIX value (check NSE). Helps calibrate volatility.</small>
                    </div>
                    <div class="form-group" style="display:flex; align-items:center; padding-top:20px;">
                        <div id="vixIndicator" style="display:none; padding:10px 15px; border-radius:8px; font-size:0.85rem; font-weight:600;"></div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-arrows-split-up-and-left"></i> Exit Strategy</label>
                        <select class="form-select" id="exitStrategy">
                            <option value="all-at-target">All at Single Target</option>
                            <option value="partial" selected>Partial Exits (50-30-20)</option>
                            <option value="trail">Trailing Stop Loss</option>
                            <option value="time">Time-Based Exit</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-hourglass-half"></i> Max Hold Time</label>
                        <select class="form-select" id="maxHoldTime">
                            <option value="5m">5 Minutes</option>
                            <option value="15m">15 Minutes</option>
                            <option value="1h">1 Hour</option>
                            <option value="day" selected>Same Day</option>
                            <option value="swing">2-5 Days</option>
                            <option value="position">1+ Week</option>
                        </select>
                    </div>
                </div>
                
                <!-- Existing Position Analyzer -->
                <div class="form-group" style="background: linear-gradient(135deg, rgba(139,92,246,0.1) 0%, rgba(59,130,246,0.1) 100%); padding: 20px; border-radius: 16px; border: 1px solid rgba(139,92,246,0.3); margin-top: 20px;">
                    <label class="form-label" style="color: #a78bfa; font-size: 1.1rem;"><i class="fas fa-chart-pie"></i> Existing Position Analysis (F&O)</label>
                    <small style="color:#888; display:block; margin-bottom:15px;">Already in a trade? Enter details to get hold/exit recommendation</small>
                    
                    <div class="form-row">
                        <div class="form-group" style="margin-top:0;">
                            <label class="form-label" style="font-size:0.85rem;"><i class="fas fa-arrow-up"></i> Position Type</label>
                            <select class="form-select" id="existingPositionType">
                                <option value="none">No Existing Position</option>
                                <option value="long_call">BOUGHT CALL Option</option>
                                <option value="long_put">BOUGHT PUT Option</option>
                                <option value="short_call">SOLD CALL Option</option>
                                <option value="short_put">SOLD PUT Option</option>
                                <option value="long_futures">LONG Futures</option>
                                <option value="short_futures">SHORT Futures</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-top:0;">
                            <label class="form-label" style="font-size:0.85rem;"><i class="fas fa-hashtag"></i> Quantity/Lots</label>
                            <input type="number" class="form-input" id="existingQty" placeholder="e.g., 15" value="15">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group" style="margin-top:0;">
                            <label class="form-label" style="font-size:0.85rem;"><i class="fas fa-rupee-sign"></i> Your Buy/Entry Premium</label>
                            <input type="number" class="form-input" id="existingEntryPrice" placeholder="e.g., 250" step="0.05">
                            <small style="color:#666; font-size:0.7rem;">Premium you paid per lot</small>
                        </div>
                        <div class="form-group" style="margin-top:0;">
                            <label class="form-label" style="font-size:0.85rem;"><i class="fas fa-tag"></i> Current Premium (LTP)</label>
                            <input type="number" class="form-input" id="existingCurrentPrice" placeholder="e.g., 180" step="0.05">
                            <small style="color:#666; font-size:0.7rem;">Current market premium</small>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group" style="margin-top:0;">
                            <label class="form-label" style="font-size:0.85rem;"><i class="fas fa-bullseye"></i> Strike Price</label>
                            <input type="number" class="form-input" id="existingStrike" placeholder="e.g., 55000" step="50">
                        </div>
                        <div class="form-group" style="margin-top:0;">
                            <label class="form-label" style="font-size:0.85rem;"><i class="fas fa-calendar-alt"></i> Days to Expiry</label>
                            <input type="number" class="form-input" id="daysToExpiry" placeholder="e.g., 3" value="0">
                        </div>
                    </div>
                    
                    <div id="existingPositionSummary" style="display:none; margin-top:15px; padding:15px; background:rgba(0,0,0,0.3); border-radius:10px;"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-comment-dots"></i> Additional Context (Optional)</label>
                    <textarea class="form-textarea" id="additionalContext" placeholder="E.g., 'Near earnings', 'High volatility expected', 'Looking for swing entry', 'Key budget day'..."></textarea>
                </div>
                
                <button class="analyze-btn" id="analyzeBtn" onclick="analyzeChart()">
                    <div class="spinner"></div>
                    <span class="btn-text"><i class="fas fa-magic"></i> Analyze with AI</span>
                </button>
                
                <div style="text-align: center; margin-top: 15px; color: #555; font-size: 0.85rem;">
                    <i class="fas fa-keyboard"></i> Pro Tip: Press <kbd style="background: #2a2a2a; padding: 3px 8px; border-radius: 4px; color: var(--gold);">Ctrl + Enter</kbd> to analyze
                </div>
            </div>
            
            <!-- Results Section -->
            <div class="results-section" id="resultsSection">
                <!-- Analysis Disclaimer Banner -->
                <div style="background: linear-gradient(135deg, rgba(255,152,0,0.2) 0%, rgba(255,87,34,0.15) 100%); border: 2px solid #ff9800; border-radius: 12px; padding: 15px 20px; margin-bottom: 20px; display: flex; align-items: flex-start; gap: 12px;">
                    <i class="fas fa-exclamation-triangle" style="color: #ff9800; font-size: 1.5rem; margin-top: 2px;"></i>
                    <div>
                        <div style="color: #ff9800; font-weight: 700; font-size: 1rem; margin-bottom: 5px;">‚ö†Ô∏è Educational Analysis Only - Not Financial Advice</div>
                        <div style="color: rgba(255,255,255,0.8); font-size: 0.85rem; line-height: 1.5;">This AI-generated analysis is for <strong>educational and informational purposes only</strong>. It is NOT a recommendation to buy, sell, or trade any security. Trading involves substantial risk of loss. Always conduct your own research and consult a qualified financial advisor before making any investment decisions. Past patterns do not guarantee future results.</div>
                    </div>
                </div>
                
                <div class="results-header">
                    <h2 class="results-title"><i class="fas fa-poll"></i> AI Pattern Analysis Results</h2>
                    <div class="results-actions">
                        <button class="action-btn secondary" onclick="shareAnalysis()"><i class="fas fa-share-alt"></i> Share</button>
                    </div>
                </div>
                
                <!-- Signal Box -->
                <div class="signal-box" id="signalBox">
                    <div class="signal-main">
                        <div class="signal-primary">
                            <div class="signal-label">Trade Signal</div>
                            <div class="signal-value" id="signalValue">
                                <i class="fas fa-arrow-up"></i> <span>BULLISH</span>
                            </div>
                        </div>
                        
                        <div class="confidence-section">
                            <div class="confidence-circle" id="confidenceCircle" style="--confidence: 85">
                                <span class="confidence-number" id="confidencePercent">85%</span>
                            </div>
                            <div class="signal-label">Confidence Score</div>
                        </div>
                        
                        <div class="trade-type-badge">
                            <div class="signal-label">AI Pattern Assessment</div>
                            <div class="trade-badge long" id="tradeBadge">BULLISH BIAS</div>
                        </div>
                    </div>
                </div>
                
                <!-- Existing Position Advice (Hidden by default) -->
                <div id="existingPositionAdviceBox" style="display:none; background: linear-gradient(135deg, rgba(139,92,246,0.2) 0%, rgba(59,130,246,0.15) 100%); border: 2px solid #a78bfa; border-radius: 16px; padding: 25px; margin-bottom: 25px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                        <i class="fas fa-hand-holding-dollar" style="color: #a78bfa; font-size: 1.3rem;"></i>
                        <span style="color: #a78bfa; font-weight: 700; font-size: 1.1rem;">üìä Existing Position Recommendation</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="background: var(--bg-dark); border-radius: 12px; padding: 18px; text-align: center;">
                            <div style="color: #888; font-size: 0.8rem; text-transform: uppercase; margin-bottom: 8px;">Recommendation</div>
                            <div id="existingAdviceRec" style="font-size: 1.5rem; font-weight: 800;"></div>
                        </div>
                        <div style="background: var(--bg-dark); border-radius: 12px; padding: 18px; text-align: center;">
                            <div style="color: #888; font-size: 0.8rem; text-transform: uppercase; margin-bottom: 8px;">Probability of Profit</div>
                            <div id="existingAdviceProb" style="color: #fff; font-size: 1.4rem; font-weight: 700;"></div>
                        </div>
                        <div style="background: var(--bg-dark); border-radius: 12px; padding: 18px; text-align: center;">
                            <div style="color: #888; font-size: 0.8rem; text-transform: uppercase; margin-bottom: 8px;">Suggested Exit</div>
                            <div id="existingAdviceExit" style="color: var(--gold); font-size: 1.4rem; font-weight: 700; font-family: 'JetBrains Mono', monospace;"></div>
                        </div>
                        <div style="background: var(--bg-dark); border-radius: 12px; padding: 18px; text-align: center;">
                            <div style="color: #888; font-size: 0.8rem; text-transform: uppercase; margin-bottom: 8px;">Theta Impact</div>
                            <div id="existingAdviceTheta" style="font-size: 1.4rem; font-weight: 700;"></div>
                        </div>
                    </div>
                    <div style="margin-top: 15px; padding: 12px; background: rgba(0,0,0,0.3); border-radius: 10px;">
                        <div style="color: #888; font-size: 0.8rem; margin-bottom: 5px;">REASON</div>
                        <div id="existingAdviceReason" style="color: #ddd; font-size: 0.95rem; line-height: 1.5;"></div>
                    </div>
                </div>
                
                <!-- Quick Trade Summary -->
                <div style="background: linear-gradient(135deg, rgba(201,162,39,0.15) 0%, rgba(201,162,39,0.05) 100%); border: 2px solid var(--gold); border-radius: 16px; padding: 25px; margin-bottom: 25px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                        <i class="fas fa-bolt" style="color: var(--gold); font-size: 1.3rem;"></i>
                        <span style="color: var(--gold); font-weight: 700; font-size: 1.1rem;">Quick Trade Summary</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
                        <div style="background: var(--bg-dark); border-radius: 12px; padding: 15px; text-align: center;">
                            <div style="color: #666; font-size: 0.8rem; text-transform: uppercase; margin-bottom: 5px;">Entry Price</div>
                            <div style="color: var(--gold); font-size: 1.4rem; font-weight: 700; font-family: 'JetBrains Mono', monospace;" id="quickEntry">--</div>
                        </div>
                        <div style="background: var(--bg-dark); border-radius: 12px; padding: 15px; text-align: center;">
                            <div style="color: #666; font-size: 0.8rem; text-transform: uppercase; margin-bottom: 5px;">Stop Loss</div>
                            <div style="color: var(--red); font-size: 1.4rem; font-weight: 700; font-family: 'JetBrains Mono', monospace;" id="quickSL">--</div>
                        </div>
                        <div style="background: var(--bg-dark); border-radius: 12px; padding: 15px; text-align: center;">
                            <div style="color: #666; font-size: 0.8rem; text-transform: uppercase; margin-bottom: 5px;">Target (T1)</div>
                            <div style="color: var(--green); font-size: 1.4rem; font-weight: 700; font-family: 'JetBrains Mono', monospace;" id="quickT1">--</div>
                        </div>
                        <div style="background: var(--bg-dark); border-radius: 12px; padding: 15px; text-align: center;">
                            <div style="color: #666; font-size: 0.8rem; text-transform: uppercase; margin-bottom: 5px;">Quantity</div>
                            <div style="color: #fff; font-size: 1.4rem; font-weight: 700; font-family: 'JetBrains Mono', monospace;" id="quickQty">--</div>
                        </div>
                        <div style="background: var(--bg-dark); border-radius: 12px; padding: 15px; text-align: center;">
                            <div style="color: #666; font-size: 0.8rem; text-transform: uppercase; margin-bottom: 5px;">Risk:Reward</div>
                            <div style="color: var(--gold); font-size: 1.4rem; font-weight: 700;" id="quickRR">--</div>
                        </div>
                        <div style="background: var(--bg-dark); border-radius: 12px; padding: 15px; text-align: center;">
                            <div style="color: #666; font-size: 0.8rem; text-transform: uppercase; margin-bottom: 5px;">Win Prob</div>
                            <div style="color: var(--green); font-size: 1.4rem; font-weight: 700;" id="quickWinProb">--</div>
                        </div>
                    </div>
                </div>
                
                <!-- Key Levels -->
                <div class="levels-section">
                    <div class="levels-header">
                        <div class="levels-title"><i class="fas fa-layer-group"></i> Key Price Levels</div>
                    </div>
                    <div class="levels-grid">
                        <div class="level-card entry">
                            <div class="level-label"><i class="fas fa-sign-in-alt"></i> Entry</div>
                            <div class="level-value entry" id="entryLevel">--</div>
                        </div>
                        <div class="level-card target1">
                            <div class="level-label"><i class="fas fa-bullseye"></i> Target 1</div>
                            <div class="level-value target" id="target1Level">--</div>
                            <div class="level-percent positive" id="target1Pct">--</div>
                        </div>
                        <div class="level-card target2">
                            <div class="level-label"><i class="fas fa-bullseye"></i> Target 2</div>
                            <div class="level-value target" id="target2Level">--</div>
                            <div class="level-percent positive" id="target2Pct">--</div>
                        </div>
                        <div class="level-card target3">
                            <div class="level-label"><i class="fas fa-bullseye"></i> Target 3</div>
                            <div class="level-value target" id="target3Level">--</div>
                            <div class="level-percent positive" id="target3Pct">--</div>
                        </div>
                        <div class="level-card stop">
                            <div class="level-label"><i class="fas fa-hand-paper"></i> Stop Loss</div>
                            <div class="level-value stop" id="stopLevel">--</div>
                            <div class="level-percent negative" id="stopPct">--</div>
                        </div>
                    </div>
                </div>
                
                <!-- Position Calculator -->
                <div class="position-calc">
                    <div class="position-calc-header">
                        <div class="position-calc-title"><i class="fas fa-calculator"></i> Position Size Calculator</div>
                    </div>
                    <div class="capital-input-row">
                        <div class="capital-field">
                            <label>Trading Capital</label>
                            <input type="number" class="capital-input" id="calcCapital" value="100000" onchange="recalculatePosition()">
                        </div>
                        <div class="capital-field">
                            <label>Risk Amount (‚Çπ)</label>
                            <input type="number" class="capital-input" id="calcRiskAmount" readonly>
                        </div>
                        <div class="capital-field">
                            <label>Lot Size (for F&O)</label>
                            <input type="number" class="capital-input" id="calcLotSize" value="25" onchange="recalculatePosition()">
                        </div>
                    </div>
                    <div class="position-results">
                        <div class="position-stat">
                            <div class="position-stat-label">Position Size</div>
                            <div class="position-stat-value gold" id="positionSize">--</div>
                            <div class="position-stat-sub">Quantity</div>
                        </div>
                        <div class="position-stat">
                            <div class="position-stat-label">Capital Required</div>
                            <div class="position-stat-value" id="capitalRequired">--</div>
                            <div class="position-stat-sub">Investment</div>
                        </div>
                        <div class="position-stat">
                            <div class="position-stat-label">Max Loss</div>
                            <div class="position-stat-value red" id="maxLoss">--</div>
                            <div class="position-stat-sub">If SL Hit</div>
                        </div>
                        <div class="position-stat">
                            <div class="position-stat-label">Max Profit (T3)</div>
                            <div class="position-stat-value green" id="maxProfit">--</div>
                            <div class="position-stat-sub">At Target 3</div>
                        </div>
                    </div>
                </div>
                
                <!-- Volatility Analysis Section -->
                <div class="volatility-section">
                    <div class="volatility-header">
                        <div class="volatility-title"><i class="fas fa-fire-flame-curved"></i> Volatility & Market Metrics</div>
                        <div id="volatilityBadge" class="risk-level-badge medium">MODERATE</div>
                    </div>
                    <div class="volatility-grid">
                        <div class="volatility-item" style="border: 2px solid var(--purple); position: relative;">
                            <div class="volatility-label">India VIX <span class="vix-live-badge"><span class="live-dot"></span>LIVE</span></div>
                            <div class="volatility-value" id="indiaVix" style="color: var(--purple);">--</div>
                            <div class="vix-interpretation" id="vixInterpretation">Fetching live data...</div>
                        </div>
                        <div class="volatility-item">
                            <div class="volatility-label">VIX Change</div>
                            <div class="volatility-value" id="vixChange">--</div>
                        </div>
                        <div class="volatility-item">
                            <div class="volatility-label">ATR (14)</div>
                            <div class="volatility-value" id="atrValue">--</div>
                        </div>
                        <div class="volatility-item">
                            <div class="volatility-label">Daily Range</div>
                            <div class="volatility-value" id="dailyRange">--</div>
                        </div>
                    </div>
                </div>
                
                <!-- P&L Scenarios -->
                <div class="pnl-scenarios">
                    <div class="pnl-header">
                        <div class="pnl-title"><i class="fas fa-coins"></i> P&L Scenario Analysis</div>
                        <div id="bestTradeTag" class="best-trade-badge" style="display: none;"><i class="fas fa-star"></i> High Probability Trade</div>
                    </div>
                    <div class="pnl-grid">
                        <div class="pnl-card best">
                            <div class="pnl-label"><i class="fas fa-rocket"></i> Best Case (T3)</div>
                            <div class="pnl-amount positive" id="pnlBest">+‚Çπ0</div>
                            <div class="pnl-percent" id="pnlBestPct">+0% ROI</div>
                            <div class="pnl-prob" id="pnlBestProb">~25% probability</div>
                        </div>
                        <div class="pnl-card expected">
                            <div class="pnl-label"><i class="fas fa-chart-line"></i> Expected (T1)</div>
                            <div class="pnl-amount positive" id="pnlExpected">+‚Çπ0</div>
                            <div class="pnl-percent" id="pnlExpectedPct">+0% ROI</div>
                            <div class="pnl-prob" id="pnlExpectedProb">~55% probability</div>
                        </div>
                        <div class="pnl-card partial">
                            <div class="pnl-label"><i class="fas fa-arrows-split-up-and-left"></i> Partial Exit</div>
                            <div class="pnl-amount positive" id="pnlPartial">+‚Çπ0</div>
                            <div class="pnl-percent" id="pnlPartialPct">+0% ROI</div>
                            <div class="pnl-prob" id="pnlPartialProb">50% at T1, trail rest</div>
                        </div>
                        <div class="pnl-card worst">
                            <div class="pnl-label"><i class="fas fa-skull-crossbones"></i> Worst Case (SL)</div>
                            <div class="pnl-amount negative" id="pnlWorst">-‚Çπ0</div>
                            <div class="pnl-percent" id="pnlWorstPct">-0% of Capital</div>
                            <div class="pnl-prob" id="pnlWorstProb">~35% probability</div>
                        </div>
                    </div>
                </div>
                
                <!-- Exit Strategy Timeline -->
                <div class="exit-strategy-section">
                    <div class="exit-header">
                        <div class="exit-title"><i class="fas fa-route"></i> Sample Exit Strategy (Illustrative)</div>
                    </div>
                    <div class="exit-timeline">
                        <div class="exit-step">
                            <div class="exit-dot entry"><i class="fas fa-sign-in-alt"></i></div>
                            <div class="exit-info"><strong id="exitEntry">Entry</strong>100% Position</div>
                        </div>
                        <div class="exit-step">
                            <div class="exit-dot t1">50%</div>
                            <div class="exit-info"><strong id="exitT1">Target 1</strong>Book 50% profit</div>
                        </div>
                        <div class="exit-step">
                            <div class="exit-dot t2">30%</div>
                            <div class="exit-info"><strong id="exitT2">Target 2</strong>Book 30% more</div>
                        </div>
                        <div class="exit-step">
                            <div class="exit-dot t3">20%</div>
                            <div class="exit-info"><strong id="exitT3">Target 3</strong>Trail remaining</div>
                        </div>
                        <div class="exit-step">
                            <div class="exit-dot sl"><i class="fas fa-hand-paper"></i></div>
                            <div class="exit-info"><strong id="exitSL">Stop Loss</strong>Exit if hit</div>
                        </div>
                    </div>
                </div>
                
                <!-- Advanced Trading Metrics -->
                <div class="advanced-metrics">
                    <div class="adv-metric">
                        <div class="adv-metric-header">
                            <div class="adv-metric-icon kelly"><i class="fas fa-percent"></i></div>
                            <div class="adv-metric-name">Kelly Criterion</div>
                        </div>
                        <div class="adv-metric-value" id="kellyValue">--</div>
                        <div class="adv-metric-sub">Optimal position %</div>
                    </div>
                    <div class="adv-metric">
                        <div class="adv-metric-header">
                            <div class="adv-metric-icon ev"><i class="fas fa-calculator"></i></div>
                            <div class="adv-metric-name">Expected Value</div>
                        </div>
                        <div class="adv-metric-value" id="evValue">--</div>
                        <div class="adv-metric-sub">Per trade avg</div>
                    </div>
                    <div class="adv-metric">
                        <div class="adv-metric-header">
                            <div class="adv-metric-icon sharpe"><i class="fas fa-chart-line"></i></div>
                            <div class="adv-metric-name">Trade Score</div>
                        </div>
                        <div class="adv-metric-value" id="tradeScore">--</div>
                        <div class="adv-metric-sub">Quality rating</div>
                    </div>
                    <div class="adv-metric">
                        <div class="adv-metric-header">
                            <div class="adv-metric-icon drawdown"><i class="fas fa-arrow-trend-down"></i></div>
                            <div class="adv-metric-name">Max Drawdown</div>
                        </div>
                        <div class="adv-metric-value" id="maxDrawdown">--</div>
                        <div class="adv-metric-sub">If 5 losses</div>
                    </div>
                </div>
                
                <!-- Trade Timing Section -->
                <div class="timing-section">
                    <div class="timing-header">
                        <div class="timing-title"><i class="fas fa-clock"></i> Trade Timing & Management</div>
                    </div>
                    <div class="timing-grid">
                        <div class="timing-card">
                            <div class="timing-icon">‚è∞</div>
                            <div class="timing-label">Best Entry Window</div>
                            <div class="timing-value" id="entryWindow">--</div>
                        </div>
                        <div class="timing-card">
                            <div class="timing-icon">‚è±Ô∏è</div>
                            <div class="timing-label">Max Hold Time</div>
                            <div class="timing-value" id="maxHoldDisplay">--</div>
                        </div>
                        <div class="timing-card">
                            <div class="timing-icon">üö´</div>
                            <div class="timing-label">Time Stop</div>
                            <div class="timing-value" id="timeStop">--</div>
                        </div>
                    </div>
                </div>
                
                <!-- Cost Analysis -->
                <div class="cost-analysis">
                    <div class="cost-header">
                        <div class="cost-title"><i class="fas fa-receipt"></i> Trading Costs Breakdown</div>
                    </div>
                    <div class="cost-grid">
                        <div class="cost-item">
                            <div class="cost-label">Brokerage</div>
                            <div class="cost-value" id="costBrokerage">‚Çπ0</div>
                        </div>
                        <div class="cost-item">
                            <div class="cost-label">STT/CTT</div>
                            <div class="cost-value" id="costSTT">‚Çπ0</div>
                        </div>
                        <div class="cost-item">
                            <div class="cost-label">Exchange Fees</div>
                            <div class="cost-value" id="costExchange">‚Çπ0</div>
                        </div>
                        <div class="cost-item">
                            <div class="cost-label">GST (18%)</div>
                            <div class="cost-value" id="costGST">‚Çπ0</div>
                        </div>
                        <div class="cost-item cost-total">
                            <div class="cost-label">Total Costs</div>
                            <div class="cost-value" id="costTotal">‚Çπ0</div>
                        </div>
                    </div>
                </div>
                
                <!-- Risk Reward Visual -->
                <div class="rr-visual">
                    <div class="rr-header">
                        <div class="rr-title"><i class="fas fa-balance-scale"></i> Risk : Reward Analysis</div>
                        <div class="rr-ratio" id="rrRatio">1:3</div>
                    </div>
                    <div class="rr-bar">
                        <div class="rr-risk" id="rrRiskBar" style="width: 25%;">Risk</div>
                        <div class="rr-reward" id="rrRewardBar" style="width: 75%;">Reward</div>
                    </div>
                    <div class="rr-stats">
                        <div class="rr-stat">
                            <div class="rr-stat-label">Risk Amount</div>
                            <div class="rr-stat-value" style="color: var(--red);" id="rrRiskAmount">‚Çπ1,000</div>
                        </div>
                        <div class="rr-stat">
                            <div class="rr-stat-label">Reward at T1</div>
                            <div class="rr-stat-value" style="color: var(--green);" id="rrRewardT1">‚Çπ1,500</div>
                        </div>
                        <div class="rr-stat">
                            <div class="rr-stat-label">Reward at T3</div>
                            <div class="rr-stat-value" style="color: var(--green);" id="rrRewardT3">‚Çπ3,000</div>
                        </div>
                    </div>
                </div>
                
                <!-- Analysis Cards -->
                <div class="analysis-section">
                    <div class="analysis-card">
                        <div class="analysis-card-header">
                            <div class="analysis-card-icon pattern"><i class="fas fa-shapes"></i></div>
                            <div class="analysis-card-title">Pattern Detected</div>
                        </div>
                        <div class="analysis-card-value" id="patternName">--</div>
                        <div class="analysis-card-sub" id="patternReliability">--</div>
                    </div>
                    <div class="analysis-card">
                        <div class="analysis-card-header">
                            <div class="analysis-card-icon trend"><i class="fas fa-arrow-trend-up"></i></div>
                            <div class="analysis-card-title">Market Trend</div>
                        </div>
                        <div class="analysis-card-value" id="trendDirection">--</div>
                        <div class="analysis-card-sub" id="trendStrength">--</div>
                    </div>
                    <div class="analysis-card">
                        <div class="analysis-card-header">
                            <div class="analysis-card-icon momentum"><i class="fas fa-gauge-high"></i></div>
                            <div class="analysis-card-title">Momentum</div>
                        </div>
                        <div class="analysis-card-value" id="momentum">--</div>
                        <div class="analysis-card-sub" id="momentumNote">--</div>
                    </div>
                    <div class="analysis-card">
                        <div class="analysis-card-header">
                            <div class="analysis-card-icon volume"><i class="fas fa-chart-bar"></i></div>
                            <div class="analysis-card-title">Volume Analysis</div>
                        </div>
                        <div class="analysis-card-value" id="volumeAnalysis">--</div>
                        <div class="analysis-card-sub" id="volumeNote">--</div>
                    </div>
                </div>
                
                <!-- Key Metrics -->
                <div class="metrics-row">
                    <div class="metric-card">
                        <div class="metric-icon">‚è±Ô∏è</div>
                        <div class="metric-label">Trade Horizon</div>
                        <div class="metric-value" id="tradeHorizon">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon">üìè</div>
                        <div class="metric-label">Expected Move</div>
                        <div class="metric-value" id="expectedMove">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon">üé≤</div>
                        <div class="metric-label">Win Probability</div>
                        <div class="metric-value" id="winProbability">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon">üìä</div>
                        <div class="metric-label">Volatility</div>
                        <div class="metric-value" id="volatility">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon">üéØ</div>
                        <div class="metric-label">Breakeven</div>
                        <div class="metric-value" id="breakeven">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon">‚ö°</div>
                        <div class="metric-label">Setup Quality</div>
                        <div class="metric-value" id="setupQuality">--</div>
                    </div>
                </div>
                
                <!-- Indicators -->
                <div class="indicators-section">
                    <div class="levels-title" style="margin-bottom: 20px;"><i class="fas fa-chart-line"></i> Technical Indicators</div>
                    <div class="indicators-grid">
                        <div class="indicator-item">
                            <div class="indicator-name">RSI (14)</div>
                            <div class="indicator-value" id="rsiValue">--</div>
                            <div class="indicator-signal" id="rsiSignal">--</div>
                        </div>
                        <div class="indicator-item">
                            <div class="indicator-name">MACD</div>
                            <div class="indicator-value" id="macdValue">--</div>
                            <div class="indicator-signal" id="macdSignal">--</div>
                        </div>
                        <div class="indicator-item">
                            <div class="indicator-name">Moving Avg</div>
                            <div class="indicator-value" id="maValue">--</div>
                            <div class="indicator-signal" id="maSignal">--</div>
                        </div>
                        <div class="indicator-item">
                            <div class="indicator-name">VWAP</div>
                            <div class="indicator-value" id="vwapValue">--</div>
                            <div class="indicator-signal" id="vwapSignal">--</div>
                        </div>
                        <div class="indicator-item">
                            <div class="indicator-name">Stochastic</div>
                            <div class="indicator-value" id="stochValue">--</div>
                            <div class="indicator-signal" id="stochSignal">--</div>
                        </div>
                        <div class="indicator-item">
                            <div class="indicator-name">Bollinger</div>
                            <div class="indicator-value" id="bollingerValue">--</div>
                            <div class="indicator-signal" id="bollingerSignal">--</div>
                        </div>
                        <div class="indicator-item">
                            <div class="indicator-name">ADX</div>
                            <div class="indicator-value" id="adxValue">--</div>
                            <div class="indicator-signal" id="adxSignal">--</div>
                        </div>
                        <div class="indicator-item">
                            <div class="indicator-name">Supertrend</div>
                            <div class="indicator-value" id="supertrendValue">--</div>
                            <div class="indicator-signal" id="supertrendSignal">--</div>
                        </div>
                    </div>
                </div>
                
                <!-- Market Context Section -->
                <div class="volatility-section">
                    <div class="volatility-header">
                        <div class="volatility-title"><i class="fas fa-globe"></i> Market Context & Sentiment</div>
                    </div>
                    <div class="volatility-grid">
                        <div class="volatility-item">
                            <div class="volatility-label">Market Phase</div>
                            <div class="volatility-value" id="marketPhase">--</div>
                        </div>
                        <div class="volatility-item">
                            <div class="volatility-label">Trend Strength</div>
                            <div class="volatility-value" id="trendStrengthVal">--</div>
                        </div>
                        <div class="volatility-item">
                            <div class="volatility-label">Sector Outlook</div>
                            <div class="volatility-value" id="sectorOutlook">--</div>
                        </div>
                        <div class="volatility-item">
                            <div class="volatility-label">Market Bias</div>
                            <div class="volatility-value" id="marketBias">--</div>
                        </div>
                    </div>
                </div>
                
                <!-- Trade Checklist -->
                <div class="checklist-section">
                    <div class="checklist-title"><i class="fas fa-clipboard-check"></i> Trade Checklist</div>
                    <div class="checklist-grid" id="checklistGrid"></div>
                </div>
                
                <!-- Detailed Analysis -->
                <div class="detailed-analysis">
                    <div class="detailed-analysis-header">
                        <i class="fas fa-file-alt" style="color: var(--gold); font-size: 1.2rem;"></i>
                        <h4>Detailed AI Analysis</h4>
                    </div>
                    <div class="detailed-analysis-content" id="detailedText">
                        <p>AI analysis will appear here...</p>
                    </div>
                </div>
                
                <!-- Risk Meter -->
                <div class="risk-meter">
                    <div class="risk-meter-header">
                        <div class="risk-meter-title"><i class="fas fa-tachometer-alt"></i> Overall Risk Level</div>
                        <div class="risk-level-badge" id="riskBadge">MODERATE</div>
                    </div>
                    <div class="risk-scale" id="riskScale">
                        <div class="risk-segment"></div>
                        <div class="risk-segment"></div>
                        <div class="risk-segment"></div>
                        <div class="risk-segment"></div>
                        <div class="risk-segment"></div>
                    </div>
                    <div class="risk-labels">
                        <span>Very Low</span>
                        <span>Low</span>
                        <span>Moderate</span>
                        <span>High</span>
                        <span>Very High</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="action-btn primary" onclick="copyAnalysis()" id="copyBtn">
                        <i class="fas fa-copy"></i> Copy Full Analysis
                    </button>
                    <button class="action-btn secondary" onclick="copyLevelsOnly()">
                        <i class="fas fa-bullseye"></i> Copy Levels Only
                    </button>
                    <button class="action-btn secondary" onclick="saveToJournal()">
                        <i class="fas fa-book"></i> Save to Journal
                    </button>
                    <button class="action-btn success" onclick="newAnalysis()">
                        <i class="fas fa-plus"></i> New Analysis
                    </button>
                </div>
                
                <!-- Results Section Disclaimer -->
                <div style="background: rgba(255,152,0,0.1); border: 1px solid rgba(255,152,0,0.3); border-radius: 10px; padding: 15px; margin-top: 20px; text-align: center;">
                    <p style="color: #ff9800; font-size: 0.85rem; margin: 0;">
                        <i class="fas fa-info-circle"></i> <strong>Reminder:</strong> This AI analysis is for educational purposes only. Always verify with your own research and consult a SEBI-registered advisor before trading.
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Disclaimers Anchor -->
        <div id="disclaimers"></div>
        
        <!-- SEBI Compliance & Regulatory Disclaimer -->
        <div class="disclaimer" style="border-color: rgba(255,87,34,0.5); margin-top: 40px;">
            <div class="disclaimer-header">
                <div class="disclaimer-icon" style="background: rgba(255,87,34,0.2);"><i class="fas fa-gavel"></i></div>
                <div class="disclaimer-title" style="color: #ff5722;">‚öñÔ∏è SEBI Regulatory Compliance Notice</div>
            </div>
            <p style="border-left: 3px solid #ff5722; padding-left: 15px; margin-bottom: 15px;"><strong style="color: #ff5722;">SEBI REGISTRATION DISCLAIMER:</strong> BroBillionaire is NOT a SEBI registered investment advisor (RIA), research analyst (RA), or portfolio manager. We do NOT hold any license from SEBI (Securities and Exchange Board of India) to provide investment advice. This tool is strictly for educational and informational purposes only.</p>
            <p><strong>NO INVESTMENT ADVICE:</strong> Nothing on this platform constitutes investment advice, financial advice, trading advice, or any other form of advice. This AI tool does NOT recommend buying, selling, or holding any securities, derivatives, or financial instruments.</p>
            <p><strong>SEBI REGULATIONS COMPLIANCE:</strong> In accordance with SEBI (Investment Advisers) Regulations, 2013 and SEBI (Research Analysts) Regulations, 2014, we explicitly state that we are NOT authorized to provide personalized investment recommendations. Users should consult SEBI-registered professionals for investment decisions.</p>
            <p><strong>NO CLIENT RELATIONSHIP:</strong> Use of this tool does NOT create any advisory, fiduciary, or professional services relationship between you and BroBillionaire.</p>
        </div>

        <!-- Risk Disclosure Disclaimer -->
        <div class="disclaimer" style="border-color: rgba(239,68,68,0.5);">
            <div class="disclaimer-header">
                <div class="disclaimer-icon"><i class="fas fa-exclamation-triangle"></i></div>
                <div class="disclaimer-title">‚ö†Ô∏è Critical Risk Disclosure</div>
            </div>
            <p><strong>HIGH RISK WARNING:</strong> Trading and investing in securities market involves substantial risk of loss. You could lose some or ALL of your invested capital. Only trade with money you can afford to lose completely.</p>
            <p><strong>F&O RISK DISCLOSURE:</strong> As per SEBI guidelines, trading in Futures & Options (F&O) is extremely risky. Studies show that 9 out of 10 individual traders in the equity F&O segment incur net losses. The average loss of F&O traders is approximately ‚Çπ50,000 per person. Consider these statistics before trading in derivatives.</p>
            <p><strong>LEVERAGE RISK:</strong> Leverage/margin trading can amplify both profits AND losses. A small market movement can result in proportionally larger losses exceeding your initial investment.</p>
            <p><strong>MARKET RISK:</strong> Securities markets are subject to market risks including volatility, liquidity risk, gap risk, and black swan events. Past performance does NOT guarantee future results.</p>
            <p><strong>NO GUARANTEED RETURNS:</strong> There is NO guarantee of profits or protection against losses. All investments carry inherent risks. Historical patterns do NOT predict future market behavior.</p>
        </div>

        <!-- AI Tool Disclaimer -->
        <div class="disclaimer" style="border-color: rgba(139,92,246,0.5);">
            <div class="disclaimer-header">
                <div class="disclaimer-icon" style="background: rgba(139,92,246,0.2); color: #8b5cf6;"><i class="fas fa-robot"></i></div>
                <div class="disclaimer-title" style="color: #8b5cf6;">ü§ñ AI Tool Limitations Disclaimer</div>
            </div>
            <p><strong>AI LIMITATIONS:</strong> This AI-powered tool uses machine learning algorithms that may produce inaccurate, incomplete, or erroneous analysis. AI pattern recognition is NOT infallible and can make significant errors.</p>
            <p><strong>NOT REAL-TIME DATA:</strong> The analysis is based on the static chart image you upload. It does NOT have access to real-time market data, order flow, news events, or other crucial trading information.</p>
            <p><strong>EDUCATIONAL PURPOSE ONLY:</strong> All outputs including entry points, targets, stop-losses, and position sizes are for EDUCATIONAL demonstration only. They are NOT trading signals or recommendations.</p>
            <p><strong>VERIFY INDEPENDENTLY:</strong> Always verify any analysis output with your own research, multiple sources, and if needed, consult a SEBI-registered investment advisor before making any trading decisions.</p>
            <p><strong>NO LIABILITY:</strong> BroBillionaire, its owners, employees, and affiliates shall NOT be liable for any losses, damages, or costs arising from the use of this tool.</p>
        </div>

        <!-- Position Sizing Disclaimer -->
        <div class="disclaimer" style="border-color: rgba(245,158,11,0.5);">
            <div class="disclaimer-header">
                <div class="disclaimer-icon" style="background: rgba(245,158,11,0.2); color: #f59e0b;"><i class="fas fa-calculator"></i></div>
                <div class="disclaimer-title" style="color: #f59e0b;">üìä Position Sizing & Calculations Disclaimer</div>
            </div>
            <p><strong>ILLUSTRATIVE CALCULATIONS ONLY:</strong> All position sizing, P&L scenarios, risk-reward ratios, and cost calculations shown are for ILLUSTRATION purposes only. They may not reflect actual trading conditions, slippage, or execution prices.</p>
            <p><strong>NOT PERSONALIZED ADVICE:</strong> Position sizing should be based on YOUR personal financial situation, risk tolerance, investment objectives, and experience level. Consult a qualified financial advisor.</p>
            <p><strong>ACTUAL COSTS MAY VARY:</strong> Brokerage, STT, exchange fees, GST, and other charges may differ based on your broker, order type, and segment. Verify with your broker for accurate cost calculations.</p>
            <p><strong>SLIPPAGE & EXECUTION:</strong> Actual trade execution may differ significantly from calculated prices due to market slippage, liquidity, and order type.</p>
        </div>

        <!-- Indian Market Specific Disclaimer -->
        <div class="disclaimer" style="border-color: rgba(59,130,246,0.5);">
            <div class="disclaimer-header">
                <div class="disclaimer-icon" style="background: rgba(59,130,246,0.2); color: #3b82f6;"><i class="fas fa-flag"></i></div>
                <div class="disclaimer-title" style="color: #3b82f6;">üáÆüá≥ Indian Market Regulatory Disclaimer</div>
            </div>
            <p><strong>INDIAN SECURITIES LAWS:</strong> Trading in Indian securities markets is governed by SEBI Act 1992, Securities Contracts (Regulation) Act 1956, and various SEBI regulations. Users must comply with all applicable laws.</p>
            <p><strong>KYC & COMPLIANCE:</strong> Ensure you have completed proper KYC with your SEBI-registered broker and understand all margin requirements, mark-to-market obligations, and settlement procedures.</p>
            <p><strong>EXCHANGE RULES:</strong> All trades must be executed through recognized stock exchanges (NSE, BSE, MCX, etc.) via SEBI-registered brokers/members only.</p>
            <p><strong>TAX OBLIGATIONS:</strong> Users are solely responsible for understanding and complying with all tax obligations including STT, capital gains tax, GST, and any other applicable taxes.</p>
            <p><strong>PROHIBITION OF TIPS:</strong> As per SEBI guidelines, providing "tips" or "hot stock picks" without proper registration is prohibited. This tool does NOT provide any tips or stock recommendations.</p>
        </div>

        <!-- User Responsibility Disclaimer -->
        <div class="disclaimer" style="border-color: rgba(34,197,94,0.5);">
            <div class="disclaimer-header">
                <div class="disclaimer-icon" style="background: rgba(34,197,94,0.2); color: #22c55e;"><i class="fas fa-user-check"></i></div>
                <div class="disclaimer-title" style="color: #22c55e;">‚úÖ User Responsibility & Agreement</div>
            </div>
            <p><strong>YOUR RESPONSIBILITY:</strong> By using this tool, you acknowledge that YOU are solely responsible for your trading and investment decisions. You agree to do your own research (DYOR) before making any financial decisions.</p>
            <p><strong>PROFESSIONAL CONSULTATION:</strong> We strongly recommend consulting with a SEBI-registered Investment Advisor, Chartered Accountant, or other qualified financial professional before making investment decisions.</p>
            <p><strong>SUITABILITY:</strong> You must independently assess whether any security, strategy, or investment is appropriate for you based on your investment objectives, financial situation, and risk tolerance.</p>
            <p><strong>AGE & ELIGIBILITY:</strong> You confirm that you are above 18 years of age and are legally eligible to enter into contracts and trade in securities as per Indian law.</p>
            <p><strong>ACCEPTANCE OF RISK:</strong> By using this tool, you expressly acknowledge and accept all risks associated with trading and investing in financial markets.</p>
        </div>

        <!-- Data Privacy Disclaimer -->
        <div class="disclaimer" style="border-color: rgba(156,163,175,0.5);">
            <div class="disclaimer-header">
                <div class="disclaimer-icon" style="background: rgba(156,163,175,0.2); color: #9ca3af;"><i class="fas fa-shield-alt"></i></div>
                <div class="disclaimer-title" style="color: #9ca3af;">üîí Data Privacy & Security Notice</div>
            </div>
            <p><strong>IMAGE PROCESSING:</strong> Chart images are processed through OpenAI's API for analysis. Images are NOT permanently stored on our servers but may be temporarily processed by OpenAI as per their data policies.</p>
            <p><strong>NO FINANCIAL DATA COLLECTION:</strong> We do NOT collect, store, or have access to your trading account, portfolio, or personal financial information.</p>
            <p><strong>THIRD-PARTY SERVICES:</strong> This tool uses third-party AI services. By using this tool, you also agree to the terms of service and privacy policies of such third-party providers.</p>
            <p><strong>DO NOT SHARE SENSITIVE INFO:</strong> Do NOT upload images containing personal financial information, account numbers, passwords, or any sensitive personal data.</p>
        </div>

        <!-- Legal Disclaimer -->
        <div class="disclaimer" style="border-color: rgba(220,38,38,0.5); margin-bottom: 20px;">
            <div class="disclaimer-header">
                <div class="disclaimer-icon" style="background: rgba(220,38,38,0.2); color: #dc2626;"><i class="fas fa-balance-scale-left"></i></div>
                <div class="disclaimer-title" style="color: #dc2626;">üìú Legal Disclaimer & Limitation of Liability</div>
            </div>
            <p><strong>NO WARRANTY:</strong> This tool is provided "AS IS" without any warranties, express or implied, including but not limited to merchantability, fitness for a particular purpose, or non-infringement.</p>
            <p><strong>LIMITATION OF LIABILITY:</strong> In no event shall BroBillionaire, its owners, directors, employees, agents, or affiliates be liable for any direct, indirect, incidental, special, consequential, or punitive damages arising from your use of this tool.</p>
            <p><strong>INDEMNIFICATION:</strong> You agree to indemnify and hold harmless BroBillionaire from any claims, damages, losses, liabilities, and expenses arising from your use of this tool or violation of these terms.</p>
            <p><strong>GOVERNING LAW:</strong> These terms shall be governed by and construed in accordance with the laws of India. Any disputes shall be subject to the exclusive jurisdiction of courts in India.</p>
            <p><strong>CHANGES TO DISCLAIMER:</strong> We reserve the right to modify these disclaimers at any time. Continued use of the tool constitutes acceptance of any changes.</p>
        </div>

        <!-- Final Important Notice -->
        <div style="background: linear-gradient(135deg, rgba(239,68,68,0.15) 0%, rgba(239,68,68,0.05) 100%); border: 3px solid var(--red); border-radius: 20px; padding: 30px; margin-bottom: 30px; text-align: center;">
            <div style="font-size: 3rem; margin-bottom: 15px;">‚ö†Ô∏èüö®‚ö†Ô∏è</div>
            <h3 style="color: var(--red); font-size: 1.5rem; margin-bottom: 15px;">IMPORTANT FINAL NOTICE</h3>
            <p style="color: #fff; font-size: 1.1rem; line-height: 1.8; max-width: 900px; margin: 0 auto;">
                <strong>TRADING IN SECURITIES/F&O INVOLVES HIGH RISK.</strong><br>
                This AI analysis tool is for <strong>EDUCATIONAL & INFORMATIONAL PURPOSES ONLY</strong>.<br>
                It is <strong>NOT</strong> investment advice, NOT a recommendation, and NOT a trading signal.<br>
                <strong>9 out of 10 F&O traders lose money.</strong> Trade responsibly.<br>
                Always consult a <strong>SEBI-registered advisor</strong> before investing.
            </p>
            <div style="margin-top: 20px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 10px; display: inline-block;">
                <p style="color: #888; font-size: 0.85rem; margin: 0;">By using this tool, you confirm that you have read, understood, and agree to all disclaimers above.</p>
            </div>
        </div>
        
        <!-- Related Articles -->
        <section style="background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); border-radius: 20px; padding: 2.5rem; margin-top: 40px; border: 2px solid var(--gold);">
            <h2 style="font-family: 'Playfair Display', serif; font-size: 1.8rem; color: var(--gold); margin-bottom: 1.5rem; text-align: center;">üìö Master Your Trading Skills</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem;">
                <div style="background: rgba(201,162,39,0.05); border: 2px solid rgba(201,162,39,0.3); border-radius: 14px; padding: 1.5rem;">
                    <div style="display: flex; align-items: center; margin-bottom: 0.8rem;">
                        <span style="font-size: 2rem; margin-right: 0.5rem;">üìñ</span>
                        <h3 style="color: var(--gold); font-size: 1.1rem; margin: 0;">Technical Analysis Basics</h3>
                    </div>
                    <p style="color: rgba(255,255,255,0.7); margin-bottom: 1rem; font-size: 0.9rem;">Learn candlestick patterns, support/resistance, and trend identification</p>
                    <a href="article-technical-analysis-murphy.html" style="color: var(--gold); text-decoration: none; font-weight: 600;">Read Article ‚Üí</a>
                </div>
                <div style="background: rgba(201,162,39,0.05); border: 2px solid rgba(201,162,39,0.3); border-radius: 14px; padding: 1.5rem;">
                    <div style="display: flex; align-items: center; margin-bottom: 0.8rem;">
                        <span style="font-size: 2rem; margin-right: 0.5rem;">üí°</span>
                        <h3 style="color: var(--gold); font-size: 1.1rem; margin: 0;">Risk Management Guide</h3>
                    </div>
                    <p style="color: rgba(255,255,255,0.7); margin-bottom: 1rem; font-size: 0.9rem;">Position sizing, stop losses, and protecting your trading capital</p>
                    <a href="article-risk-management.html" style="color: var(--gold); text-decoration: none; font-weight: 600;">Read Article ‚Üí</a>
                </div>
                <div style="background: rgba(201,162,39,0.05); border: 2px solid rgba(201,162,39,0.3); border-radius: 14px; padding: 1.5rem;">
                    <div style="display: flex; align-items: center; margin-bottom: 0.8rem;">
                        <span style="font-size: 2rem; margin-right: 0.5rem;">üéì</span>
                        <h3 style="color: var(--gold); font-size: 1.1rem; margin: 0;">Trading Psychology</h3>
                    </div>
                    <p style="color: rgba(255,255,255,0.7); margin-bottom: 1rem; font-size: 0.9rem;">Master emotions and develop a winning trader mindset</p>
                    <a href="article-trading-psychology.html" style="color: var(--gold); text-decoration: none; font-weight: 600;">Read Article ‚Üí</a>
                </div>
            </div>
        </section>
        
        <!-- FAQ Section -->
        <section style="background: #1a1a1a; border-radius: 20px; padding: 35px; margin-top: 40px; border: 1px solid #2a2a2a;">
            <h2 style="font-family: 'Playfair Display', serif; font-size: 1.8rem; color: var(--gold); margin-bottom: 25px; text-align: center;"><i class="fas fa-question-circle"></i> Frequently Asked Questions</h2>
            
            <div itemscope itemtype="https://schema.org/FAQPage">
                <div itemscope itemprop="mainEntity" itemtype="https://schema.org/Question" style="margin-bottom: 20px; padding: 20px; background: var(--bg-dark); border-radius: 14px; border-left: 3px solid var(--gold);">
                    <h3 itemprop="name" style="color: var(--gold); margin-bottom: 10px; font-size: 1.1rem;">How does the position sizing calculator work?</h3>
                    <div itemscope itemprop="acceptedAnswer" itemtype="https://schema.org/Answer">
                        <p itemprop="text" style="color: #888; line-height: 1.7;">The position sizing calculator uses the risk percentage you select and your total capital to determine the optimal position size. It calculates: Risk Amount = Capital √ó Risk%, then Position Size = Risk Amount √∑ (Entry - Stop Loss). This ensures you never risk more than your defined percentage on any single trade.</p>
                    </div>
                </div>
                
                <div itemscope itemprop="mainEntity" itemtype="https://schema.org/Question" style="margin-bottom: 20px; padding: 20px; background: var(--bg-dark); border-radius: 14px; border-left: 3px solid var(--gold);">
                    <h3 itemprop="name" style="color: var(--gold); margin-bottom: 10px; font-size: 1.1rem;">What does the Risk:Reward ratio mean?</h3>
                    <div itemscope itemprop="acceptedAnswer" itemtype="https://schema.org/Answer">
                        <p itemprop="text" style="color: #888; line-height: 1.7;">The Risk:Reward ratio compares your potential loss to potential gain. A 1:3 ratio means for every ‚Çπ1 you risk, you could make ‚Çπ3. Professional traders typically look for setups with at least 1:2 ratio.</p>
                    </div>
                </div>
                
                <div itemscope itemprop="mainEntity" itemtype="https://schema.org/Question" style="margin-bottom: 20px; padding: 20px; background: var(--bg-dark); border-radius: 14px; border-left: 3px solid var(--gold);">
                    <h3 itemprop="name" style="color: var(--gold); margin-bottom: 10px; font-size: 1.1rem;">Why are there multiple targets?</h3>
                    <div itemscope itemprop="acceptedAnswer" itemtype="https://schema.org/Answer">
                        <p itemprop="text" style="color: #888; line-height: 1.7;">Multiple targets allow you to scale out of positions and lock in profits. A common strategy: Exit 50% at Target 1, 30% at Target 2, and trail stop the remaining 20% to Target 3.</p>
                    </div>
                </div>
                
                <div itemscope itemprop="mainEntity" itemtype="https://schema.org/Question" style="padding: 20px; background: var(--bg-dark); border-radius: 14px; border-left: 3px solid var(--gold);">
                    <h3 itemprop="name" style="color: var(--gold); margin-bottom: 10px; font-size: 1.1rem;">How accurate is the AI pattern detection?</h3>
                    <div itemscope itemprop="acceptedAnswer" itemtype="https://schema.org/Answer">
                        <p itemprop="text" style="color: #888; line-height: 1.7;">GPT-4 Vision has strong pattern recognition but is not infallible. Always verify the AI's analysis with your own understanding. Use it as a second opinion, not the sole decision-maker.</p>
                    </div>
                </div>
            </div>
        </section>
    </div>
    
    <script>
        // OpenAI API key is now stored securely in server .env file
        // All API calls go through /api/openai/chat proxy
        
        let uploadedImageBase64 = null;
        let currentAnalysis = null;
        let liveIndiaVIX = null;
        
        // ============================================
        // INDIA VIX LIVE DATA FUNCTION (Yahoo Finance API)
        // ============================================
        
        async function fetchIndiaVIX() {
            try {
                // Use server proxy to avoid CORS issues
                const url = '/api/indiavix';
                const response = await fetch(url);
                const data = await response.json();
                if (data.chart?.result?.[0]) {
                    const result = data.chart.result[0];
                    const meta = result.meta;
                    const currentPrice = meta.regularMarketPrice || meta.previousClose;
                    const previousClose = meta.chartPreviousClose || meta.previousClose;
                    const change = currentPrice - previousClose;
                    const changePercent = previousClose ? (change / previousClose) * 100 : 0;
                    
                    liveIndiaVIX = { 
                        value: currentPrice, 
                        change, 
                        changePercent
                    };
                    
                    // Update UI
                    updateIndiaVIXDisplay();
                    
                    console.log('India VIX fetched:', liveIndiaVIX);
                    return liveIndiaVIX;
                }
            } catch (e) { 
                console.log('India VIX fetch error:', e); 
            }
            return null;
        }
        
        // Get VIX interpretation for trading
        function getVIXInterpretation(vixValue) {
            if (vixValue < 13) {
                return { level: 'Very Low', class: 'low', mood: 'Extremely Complacent - Potential reversal risk', color: 'var(--green)', slMultiplier: 0.8 };
            } else if (vixValue < 16) {
                return { level: 'Low', class: 'low', mood: 'Calm markets - Good for positional trades', color: 'var(--green)', slMultiplier: 0.9 };
            } else if (vixValue < 20) {
                return { level: 'Moderate', class: 'medium', mood: 'Normal volatility - Standard risk management', color: 'var(--orange)', slMultiplier: 1.0 };
            } else if (vixValue < 25) {
                return { level: 'Elevated', class: 'medium', mood: 'Caution advised - Widen stop losses', color: 'var(--orange)', slMultiplier: 1.2 };
            } else if (vixValue < 30) {
                return { level: 'High', class: 'high', mood: 'High volatility - Reduce position size', color: 'var(--red)', slMultiplier: 1.5 };
            } else {
                return { level: 'Extreme', class: 'high', mood: 'Panic - Avoid new trades, very wide SL', color: 'var(--red)', slMultiplier: 2.0 };
            }
        }
        
        // Update India VIX display in the volatility section
        function updateIndiaVIXDisplay() {
            if (!liveIndiaVIX) return;
            
            const vixEl = document.getElementById('indiaVix');
            const vixChangeEl = document.getElementById('vixChange');
            const vixInterpEl = document.getElementById('vixInterpretation');
            const volBadge = document.getElementById('volatilityBadge');
            
            if (vixEl) {
                vixEl.textContent = liveIndiaVIX.value.toFixed(2);
            }
            
            if (vixChangeEl) {
                const changeSign = liveIndiaVIX.changePercent >= 0 ? '+' : '';
                vixChangeEl.textContent = `${changeSign}${liveIndiaVIX.changePercent.toFixed(2)}%`;
                // For VIX, positive = more fear = red, negative = less fear = green
                vixChangeEl.style.color = liveIndiaVIX.changePercent >= 0 ? 'var(--red)' : 'var(--green)';
            }
            
            const vixInfo = getVIXInterpretation(liveIndiaVIX.value);
            
            if (vixInterpEl) {
                vixInterpEl.textContent = vixInfo.mood;
                vixInterpEl.style.color = vixInfo.color;
            }
            
            if (volBadge) {
                volBadge.textContent = vixInfo.level.toUpperCase();
                volBadge.className = `risk-level-badge ${vixInfo.class}`;
            }
        }
        
        // Adjust position sizing based on VIX
        function getVIXAdjustedRisk(baseRiskPercent) {
            if (!liveIndiaVIX) return baseRiskPercent;
            
            const vixInfo = getVIXInterpretation(liveIndiaVIX.value);
            // In high VIX, reduce position size; in low VIX, can use normal size
            const adjustedRisk = baseRiskPercent / vixInfo.slMultiplier;
            return Math.max(0.25, adjustedRisk); // Minimum 0.25% risk
        }
        
        // Initialize VIX data on page load
        document.addEventListener('DOMContentLoaded', function() {
            fetchIndiaVIX();
            // Refresh VIX every 2 minutes
            setInterval(fetchIndiaVIX, 120000);
        });
        
        // ============================================
        // END INDIA VIX FUNCTIONS
        // ============================================
        
        const uploadZone = document.getElementById('uploadZone');
        const chartInput = document.getElementById('chartInput');
        const uploadPreview = document.getElementById('uploadPreview');
        
        // Make upload zone focusable
        uploadZone.setAttribute('tabindex', '0');
        
        uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('dragover'); });
        uploadZone.addEventListener('dragleave', () => { uploadZone.classList.remove('dragover'); });
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) handleImageUpload(file);
        });
        
        chartInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleImageUpload(file);
        });
        
        // Handle paste from clipboard (Ctrl+V / Cmd+V) - GLOBAL
        document.addEventListener('paste', function(e) {
            console.log('Paste event detected');
            
            // Get clipboard data
            const clipboardData = e.clipboardData || window.clipboardData;
            if (!clipboardData) {
                console.log('No clipboard data');
                return;
            }
            
            const items = clipboardData.items;
            if (!items) {
                console.log('No items in clipboard');
                return;
            }
            
            console.log('Clipboard items:', items.length);
            
            // Look for image in clipboard
            for (let i = 0; i < items.length; i++) {
                console.log('Item type:', items[i].type);
                
                if (items[i].type.indexOf('image') !== -1) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const blob = items[i].getAsFile();
                    if (blob) {
                        console.log('Image blob found, size:', blob.size);
                        handleImageUpload(blob);
                        showPasteNotification('‚úÖ Image pasted successfully!');
                    }
                    return;
                }
            }
            
            // Also check for files (some browsers put images here)
            const files = clipboardData.files;
            if (files && files.length > 0) {
                for (let i = 0; i < files.length; i++) {
                    if (files[i].type.indexOf('image') !== -1) {
                        e.preventDefault();
                        handleImageUpload(files[i]);
                        showPasteNotification('‚úÖ Image pasted successfully!');
                        return;
                    }
                }
            }
        });
        
        // Click handler - modified to not interfere with paste
        uploadZone.addEventListener('click', function(e) {
            // Don't open file picker if we just pasted
            if (e.target.closest('.clear-image')) return;
            chartInput.click();
        });
        
        // Handle keyboard paste when upload zone is focused
        uploadZone.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'v') {
                // Let the paste event handle it
                console.log('Ctrl+V pressed on upload zone');
            }
        });
        
        function showPasteNotification(message) {
            // Remove existing notification
            const existing = document.querySelector('.paste-notification');
            if (existing) existing.remove();
            
            // Create notification element
            const notification = document.createElement('div');
            notification.className = 'paste-notification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
                color: white;
                padding: 15px 25px;
                border-radius: 12px;
                font-weight: 600;
                font-size: 1rem;
                z-index: 10000;
                box-shadow: 0 10px 40px rgba(34, 197, 94, 0.4);
                transform: translateX(0);
                opacity: 1;
                transition: all 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Remove after 2.5 seconds
            setTimeout(() => {
                notification.style.transform = 'translateX(100px)';
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 2500);
        }
        
        function handleImageUpload(file) {
            if (file.size > 20 * 1024 * 1024) { alert('File size exceeds 20MB limit'); return; }
            
            // Validate image type
            const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
            if (!validTypes.includes(file.type)) {
                alert('Please upload a valid image file (JPEG, PNG, GIF, or WebP)');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    // Compress image if too large (helps with API processing)
                    const maxDimension = 2048;
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > maxDimension || height > maxDimension) {
                        if (width > height) {
                            height = (height / width) * maxDimension;
                            width = maxDimension;
                        } else {
                            width = (width / height) * maxDimension;
                            height = maxDimension;
                        }
                        
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Convert to JPEG with good quality for better API compatibility
                        uploadedImageBase64 = canvas.toDataURL('image/jpeg', 0.9);
                        console.log('Image resized to:', width, 'x', height);
                    } else {
                        uploadedImageBase64 = e.target.result;
                    }
                    
                    uploadPreview.src = uploadedImageBase64;
                    uploadZone.classList.add('has-image');
                };
                img.onerror = () => {
                    alert('Failed to load image. Please try a different file.');
                };
                img.src = e.target.result;
            };
            reader.onerror = () => {
                alert('Failed to read file. Please try again.');
            };
            reader.readAsDataURL(file);
        }
        
        function clearImage(e) {
            e.stopPropagation();
            uploadedImageBase64 = null;
            uploadPreview.src = '';
            uploadZone.classList.remove('has-image');
            chartInput.value = '';
        }
        
        document.querySelectorAll('.checkbox-item').forEach(item => {
            item.addEventListener('click', () => { item.classList.toggle('checked'); });
        });
        
        function selectStyle(el) {
            document.querySelectorAll('.style-option').forEach(opt => opt.classList.remove('selected'));
            el.classList.add('selected');
        }
        
        document.getElementById('capitalInput').addEventListener('change', function() {
            document.getElementById('calcCapital').value = this.value;
        });
        
        // India VIX indicator
        document.getElementById('indiaVixInput').addEventListener('input', function() {
            const vix = parseFloat(this.value);
            const indicator = document.getElementById('vixIndicator');
            if (vix && vix > 0) {
                indicator.style.display = 'block';
                if (vix < 13) {
                    indicator.style.background = 'rgba(34,197,94,0.2)';
                    indicator.style.color = '#22c55e';
                    indicator.style.border = '1px solid #22c55e';
                    indicator.innerHTML = 'üòå Low VIX - Calm Markets';
                } else if (vix < 18) {
                    indicator.style.background = 'rgba(59,130,246,0.2)';
                    indicator.style.color = '#3b82f6';
                    indicator.style.border = '1px solid #3b82f6';
                    indicator.innerHTML = 'üìä Normal VIX';
                } else if (vix < 25) {
                    indicator.style.background = 'rgba(245,158,11,0.2)';
                    indicator.style.color = '#f59e0b';
                    indicator.style.border = '1px solid #f59e0b';
                    indicator.innerHTML = '‚ö†Ô∏è High VIX - Volatile';
                } else {
                    indicator.style.background = 'rgba(239,68,68,0.2)';
                    indicator.style.color = '#ef4444';
                    indicator.style.border = '1px solid #ef4444';
                    indicator.innerHTML = 'üî• Extreme VIX - Very Risky';
                }
            } else {
                indicator.style.display = 'none';
            }
        });
        
        // Existing Position Calculator
        function updateExistingPositionSummary() {
            const entryPremium = parseFloat(document.getElementById('existingEntryPrice').value);
            const currentPremium = parseFloat(document.getElementById('existingCurrentPrice').value);
            const strikePrice = parseFloat(document.getElementById('existingStrike').value);
            const spotPrice = parseFloat(document.getElementById('referencePriceInput').value);
            const qty = parseFloat(document.getElementById('existingQty').value) || 1;
            const posType = document.getElementById('existingPositionType').value;
            const daysToExpiry = parseInt(document.getElementById('daysToExpiry').value) || 0;
            const summaryDiv = document.getElementById('existingPositionSummary');
            
            if (!entryPremium || !currentPremium || posType === 'none') {
                summaryDiv.style.display = 'none';
                return;
            }
            
            let pnl = 0;
            let pnlPct = 0;
            let direction = '';
            let breakeven = 0;
            let intrinsicValue = 0;
            let timeValue = 0;
            let moneyness = '';
            
            // Lot size for BANKNIFTY is 15, NIFTY is 25
            const lotSize = qty;
            
            if (posType === 'long_call') {
                // Bought Call: Profit when premium increases
                pnl = (currentPremium - entryPremium) * lotSize;
                pnlPct = ((currentPremium - entryPremium) / entryPremium * 100);
                direction = 'LONG CALL';
                breakeven = strikePrice ? strikePrice + entryPremium : entryPremium;
                if (strikePrice && spotPrice) {
                    intrinsicValue = Math.max(0, spotPrice - strikePrice);
                    timeValue = currentPremium - intrinsicValue;
                    moneyness = spotPrice > strikePrice ? 'ITM' : spotPrice < strikePrice ? 'OTM' : 'ATM';
                }
            } else if (posType === 'long_put') {
                // Bought Put: Profit when premium increases (underlying falls)
                pnl = (currentPremium - entryPremium) * lotSize;
                pnlPct = ((currentPremium - entryPremium) / entryPremium * 100);
                direction = 'LONG PUT';
                breakeven = strikePrice ? strikePrice - entryPremium : entryPremium;
                if (strikePrice && spotPrice) {
                    intrinsicValue = Math.max(0, strikePrice - spotPrice);
                    timeValue = currentPremium - intrinsicValue;
                    moneyness = spotPrice < strikePrice ? 'ITM' : spotPrice > strikePrice ? 'OTM' : 'ATM';
                }
            } else if (posType === 'short_call') {
                // Sold Call: Profit when premium decreases
                pnl = (entryPremium - currentPremium) * lotSize;
                pnlPct = ((entryPremium - currentPremium) / entryPremium * 100);
                direction = 'SHORT CALL';
                breakeven = strikePrice ? strikePrice + entryPremium : entryPremium;
                if (strikePrice && spotPrice) {
                    moneyness = spotPrice > strikePrice ? 'ITM ‚ö†Ô∏è' : spotPrice < strikePrice ? 'OTM ‚úì' : 'ATM';
                }
            } else if (posType === 'short_put') {
                // Sold Put: Profit when premium decreases
                pnl = (entryPremium - currentPremium) * lotSize;
                pnlPct = ((entryPremium - currentPremium) / entryPremium * 100);
                direction = 'SHORT PUT';
                breakeven = strikePrice ? strikePrice - entryPremium : entryPremium;
                if (strikePrice && spotPrice) {
                    moneyness = spotPrice < strikePrice ? 'ITM ‚ö†Ô∏è' : spotPrice > strikePrice ? 'OTM ‚úì' : 'ATM';
                }
            } else if (posType === 'long_futures') {
                // Long Futures: Profit when price increases
                pnl = (currentPremium - entryPremium) * lotSize;
                pnlPct = ((currentPremium - entryPremium) / entryPremium * 100);
                direction = 'LONG FUTURES';
                breakeven = entryPremium;
            } else if (posType === 'short_futures') {
                // Short Futures: Profit when price decreases
                pnl = (entryPremium - currentPremium) * lotSize;
                pnlPct = ((entryPremium - currentPremium) / entryPremium * 100);
                direction = 'SHORT FUTURES';
                breakeven = entryPremium;
            }
            
            const isProfit = pnl >= 0;
            const pnlColor = isProfit ? '#22c55e' : '#ef4444';
            const pnlIcon = isProfit ? 'üìà' : 'üìâ';
            
            // Time decay warning for options
            let timeDecayNote = '';
            if (daysToExpiry <= 3 && daysToExpiry > 0 && (posType.includes('long'))) {
                timeDecayNote = `<div style="color:#f59e0b; margin-top:10px; padding:8px; background:rgba(245,158,11,0.1); border-radius:6px;">‚ö†Ô∏è <strong>${daysToExpiry} days to expiry</strong> - High theta decay! Time value eroding fast.</div>`;
            } else if (daysToExpiry === 0 && posType.includes('long')) {
                timeDecayNote = `<div style="color:#ef4444; margin-top:10px; padding:8px; background:rgba(239,68,68,0.1); border-radius:6px;">üî• <strong>EXPIRY DAY</strong> - Maximum theta decay! Exit before 3:30 PM if OTM.</div>`;
            }
            
            // Moneyness indicator
            let moneynessNote = '';
            if (moneyness) {
                const mColor = moneyness.includes('ITM') ? '#22c55e' : moneyness.includes('OTM') ? '#ef4444' : '#f59e0b';
                moneynessNote = `<div style="margin-top:8px;"><span style="color:${mColor}; font-weight:600;">${moneyness}</span> ${intrinsicValue > 0 ? `| IV: ‚Çπ${intrinsicValue.toFixed(2)} | TV: ‚Çπ${timeValue.toFixed(2)}` : ''}</div>`;
            }
            
            summaryDiv.style.display = 'block';
            summaryDiv.innerHTML = `
                <div style="display:grid; grid-template-columns: repeat(5, 1fr); gap:12px; text-align:center;">
                    <div>
                        <div style="color:#888; font-size:0.7rem;">POSITION</div>
                        <div style="color:#a78bfa; font-weight:700; font-size:0.9rem;">${direction}</div>
                    </div>
                    <div>
                        <div style="color:#888; font-size:0.7rem;">P&L</div>
                        <div style="color:${pnlColor}; font-weight:700;">${pnlIcon} ‚Çπ${pnl.toLocaleString('en-IN', {maximumFractionDigits: 0})}</div>
                    </div>
                    <div>
                        <div style="color:#888; font-size:0.7rem;">P&L %</div>
                        <div style="color:${pnlColor}; font-weight:700;">${pnlPct >= 0 ? '+' : ''}${pnlPct.toFixed(2)}%</div>
                    </div>
                    <div>
                        <div style="color:#888; font-size:0.7rem;">BREAKEVEN</div>
                        <div style="color:#fff; font-weight:700;">${breakeven.toFixed(2)}</div>
                    </div>
                    <div>
                        <div style="color:#888; font-size:0.7rem;">PREMIUM CHANGE</div>
                        <div style="color:${pnlColor}; font-weight:700;">‚Çπ${entryPremium} ‚Üí ‚Çπ${currentPremium}</div>
                    </div>
                </div>
                ${moneynessNote}
                ${timeDecayNote}
            `;
        }
        
        // Add event listeners for existing position inputs
        ['existingEntryPrice', 'existingCurrentPrice', 'existingQty', 'existingPositionType', 'daysToExpiry', 'referencePriceInput', 'existingStrike'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('input', updateExistingPositionSummary);
                el.addEventListener('change', updateExistingPositionSummary);
            }
        });
        
        async function analyzeChart() {
            if (!uploadedImageBase64) { alert('Please upload a chart image first'); return; }
            
            const analyzeBtn = document.getElementById('analyzeBtn');
            analyzeBtn.classList.add('loading');
            analyzeBtn.disabled = true;
            
            const assetType = document.getElementById('assetType').value;
            const timeframe = document.getElementById('timeframe').value;
            const tradingStyle = document.querySelector('.style-option.selected')?.dataset.style || 'daytrader';
            const additionalContext = document.getElementById('additionalContext').value;
            const capital = parseFloat(document.getElementById('capitalInput').value) || 100000;
            const riskPercent = parseFloat(document.getElementById('riskPercent').value) || 1;
            const referencePrice = parseFloat(document.getElementById('referencePriceInput').value) || null;
            
            // Existing position data
            const existingEntry = parseFloat(document.getElementById('existingEntryPrice').value) || null;
            const existingQty = parseFloat(document.getElementById('existingQty').value) || 0;
            const existingPosType = document.getElementById('existingPositionType').value;
            const daysToExpiry = parseInt(document.getElementById('daysToExpiry').value) || 0;
            
            if (!referencePrice) {
                alert('Please enter the Current Price from your chart for accurate analysis.\n\nLook at the last candle or the price line on the right side of your chart.');
                analyzeBtn.classList.remove('loading');
                analyzeBtn.disabled = false;
                return;
            }
            
            const focusAreas = [];
            document.querySelectorAll('.checkbox-item.checked').forEach(item => { focusAreas.push(item.dataset.value); });
            
            const assetTypeMap = { 'stock': 'Stock/Equity', 'index': 'Index (NIFTY/BANKNIFTY)', 'forex': 'Forex/Currency', 'crypto': 'Cryptocurrency', 'commodity': 'Commodity', 'options': 'Options/F&O' };
            const timeframeMap = { '1m': '1 Minute', '5m': '5 Minutes', '15m': '15 Minutes', '1h': '1 Hour', '4h': '4 Hours', '1d': 'Daily', '1w': 'Weekly' };
            const maxHoldMap = { '5m': '5 minutes', '15m': '15 minutes', '1h': '1 hour', 'day': 'same trading day (intraday)', 'swing': '2-5 trading days', 'position': '1-4 weeks' };
            
            const leverage = document.getElementById('leverageInput').value;
            const brokerage = document.getElementById('brokerageInput').value;
            const marketSession = document.getElementById('marketSession').value;
            const expectedVol = document.getElementById('expectedVolatility').value;
            const indiaVixInput = parseFloat(document.getElementById('indiaVixInput').value) || null;
            const exitStrategy = document.getElementById('exitStrategy').value;
            const maxHold = document.getElementById('maxHoldTime').value;
            
            // Define realistic move expectations based on asset type and timeframe
            const realisticMoves = {
                'index': { 'scalper': { t1: 0.15, t2: 0.25, t3: 0.4, sl: 0.1 }, 'daytrader': { t1: 0.3, t2: 0.5, t3: 0.8, sl: 0.2 }, 'swing': { t1: 1.0, t2: 1.8, t3: 2.5, sl: 0.6 } },
                'stock': { 'scalper': { t1: 0.3, t2: 0.5, t3: 0.8, sl: 0.2 }, 'daytrader': { t1: 0.5, t2: 1.0, t3: 1.5, sl: 0.3 }, 'swing': { t1: 2.0, t2: 4.0, t3: 6.0, sl: 1.5 } },
                'crypto': { 'scalper': { t1: 0.5, t2: 1.0, t3: 1.5, sl: 0.3 }, 'daytrader': { t1: 1.0, t2: 2.0, t3: 3.0, sl: 0.7 }, 'swing': { t1: 5.0, t2: 10.0, t3: 15.0, sl: 3.0 } },
                'forex': { 'scalper': { t1: 0.05, t2: 0.08, t3: 0.12, sl: 0.03 }, 'daytrader': { t1: 0.1, t2: 0.2, t3: 0.3, sl: 0.08 }, 'swing': { t1: 0.5, t2: 1.0, t3: 1.5, sl: 0.3 } },
                'commodity': { 'scalper': { t1: 0.2, t2: 0.4, t3: 0.6, sl: 0.15 }, 'daytrader': { t1: 0.5, t2: 0.8, t3: 1.2, sl: 0.3 }, 'swing': { t1: 1.5, t2: 3.0, t3: 4.5, sl: 1.0 } },
                'options': { 'scalper': { t1: 2.0, t2: 4.0, t3: 6.0, sl: 1.5 }, 'daytrader': { t1: 5.0, t2: 10.0, t3: 15.0, sl: 3.0 }, 'swing': { t1: 15.0, t2: 30.0, t3: 50.0, sl: 10.0 } }
            };
            
            const moveGuide = realisticMoves[assetType]?.[tradingStyle] || realisticMoves['index']['daytrader'];
            
            // Build existing position context for prompt
            let existingPosContext = '';
            let existingPosAnalysis = '';
            if (existingEntry && existingPosType !== 'none') {
                const pnl = existingPosType === 'long' ? (referencePrice - existingEntry) : (existingEntry - referencePrice);
                const pnlPct = (pnl / existingEntry * 100).toFixed(2);
                const isProfit = pnl >= 0;
                existingPosContext = `
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
‚ö†Ô∏è EXISTING POSITION - NEED HOLD/EXIT RECOMMENDATION:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
‚Ä¢ Position: ${existingPosType.toUpperCase()}
‚Ä¢ Entry Price: ${existingEntry}
‚Ä¢ Current Price: ${referencePrice}
‚Ä¢ P&L: ${isProfit ? '+' : ''}${pnlPct}% (${isProfit ? 'PROFIT' : 'LOSS'})
‚Ä¢ Quantity: ${existingQty}
‚Ä¢ Days to Expiry: ${daysToExpiry}
${daysToExpiry <= 3 ? '‚Ä¢ ‚ö†Ô∏è THETA DECAY WARNING - Close to expiry!' : ''}

MUST ANSWER: Should the trader HOLD, BOOK PROFIT, or EXIT WITH LOSS?
Consider: trend direction, momentum, time decay, probability of recovery.
`;
                existingPosAnalysis = `
7. EXISTING POSITION RECOMMENDATION:
   - Given the ${existingPosType.toUpperCase()} position from ${existingEntry}
   - Current P&L is ${pnlPct}%
   - Should trader: HOLD / BOOK PARTIAL / BOOK FULL / CUT LOSS?
   - Probability of reaching breakeven if in loss?
   - Time decay impact if options (${daysToExpiry} days left)?
`;
            }
            
            const prompt = `ANALYZE THIS TRADING CHART IN DETAIL.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
CHART INFO:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
‚Ä¢ Current Price: ${referencePrice}
‚Ä¢ Asset: ${assetTypeMap[assetType]}
‚Ä¢ Timeframe: ${timeframeMap[timeframe]}
‚Ä¢ Trading Style: ${tradingStyle.toUpperCase()}
‚Ä¢ Max Hold: ${maxHoldMap[maxHold]}
${indiaVixInput ? `‚Ä¢ India VIX: ${indiaVixInput}` : ''}
${additionalContext ? `‚Ä¢ Notes: ${additionalContext}` : ''}
${existingPosContext}
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
PERFORM DEEP TECHNICAL ANALYSIS:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

1. TREND ANALYSIS:
   - Is price making higher highs/higher lows (UPTREND)?
   - Is price making lower highs/lower lows (DOWNTREND)?
   - Is price moving sideways (CONSOLIDATION)?
   - Where is price relative to key moving averages?

2. PATTERN RECOGNITION:
   - Look for: Triangles (ascending/descending/symmetrical), Head & Shoulders, Double Top/Bottom, Flags, Pennants, Wedges, Channels, Cup & Handle
   - Is the pattern completed or still forming?
   - What is the pattern's measured move target?

3. SUPPORT & RESISTANCE:
   - Identify horizontal S/R levels
   - Note any trendlines acting as dynamic S/R
   - Where are the most recent swing highs and swing lows?

4. CANDLESTICK ANALYSIS:
   - What does the most recent candle show? (bullish/bearish/indecision)
   - Any reversal patterns? (hammer, shooting star, engulfing, doji)
   - Momentum of recent candles

5. INDICATOR READINGS (if visible):
   - RSI: Value and overbought/oversold status
   - MACD: Bullish/bearish crossover, histogram direction
   - Moving Averages: Price above or below, golden/death cross
   - Any divergences between price and indicators?

6. VOLUME (if visible):
   - Is volume confirming the move?
   - Any volume spikes or divergences?

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
TRADE RECOMMENDATION:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Based on your analysis, recommend:
- LONG if bullish setup with entry at ${referencePrice}
- SHORT if bearish setup with entry at ${referencePrice}
- WAIT if no clear setup or conflicting signals

Pre-calculated levels for reference:
‚Ä¢ LONG targets: T1=${(referencePrice * (1 + moveGuide.t1/100)).toFixed(2)}, T2=${(referencePrice * (1 + moveGuide.t2/100)).toFixed(2)}, T3=${(referencePrice * (1 + moveGuide.t3/100)).toFixed(2)}, SL=${(referencePrice * (1 - moveGuide.sl/100)).toFixed(2)}
‚Ä¢ SHORT targets: T1=${(referencePrice * (1 - moveGuide.t1/100)).toFixed(2)}, T2=${(referencePrice * (1 - moveGuide.t2/100)).toFixed(2)}, T3=${(referencePrice * (1 - moveGuide.t3/100)).toFixed(2)}, SL=${(referencePrice * (1 + moveGuide.sl/100)).toFixed(2)}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
RETURN JSON RESPONSE:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

{
    "signal": "BULLISH or BEARISH or NEUTRAL",
    "confidence": 50-85,
    "tradeType": "LONG or SHORT or WAIT",
    "entry": ${referencePrice},
    "target1": ${(referencePrice * (1 + moveGuide.t1/100)).toFixed(2)},
    "target2": ${(referencePrice * (1 + moveGuide.t2/100)).toFixed(2)},
    "target3": ${(referencePrice * (1 + moveGuide.t3/100)).toFixed(2)},
    "stopLoss": ${(referencePrice * (1 - moveGuide.sl/100)).toFixed(2)},
    "riskRewardRatio": "1:2",
    "pattern": "Ascending Triangle",
    "patternReliability": "High",
    "trend": "Uptrend",
    "trendStrength": "Strong",
    "momentum": "Bullish",
    "momentumNote": "Price making higher highs",
    "volume": "Average",
    "volumeNote": "Steady volume on breakout",
    "tradeHorizon": "${tradingStyle === 'scalper' ? 'Scalp' : tradingStyle === 'daytrader' ? 'Intraday' : 'Swing'}",
    "expectedMove": "0.5%",
    "winProbability": "60%",
    "volatility": "Medium",
    "setupQuality": "A",
    "riskLevel": 2,
    "rsi": {"value": "55", "signal": "NEUTRAL"},
    "macd": {"value": "Bullish crossover", "signal": "BULLISH"},
    "movingAverage": {"value": "Above 20 EMA", "signal": "ABOVE"},
    "vwap": {"value": "Above VWAP", "signal": "ABOVE"},
    "stochastic": {"value": "N/A", "signal": "NEUTRAL"},
    "bollinger": {"value": "Middle band", "signal": "MIDDLE"},
    "adx": {"value": "N/A", "signal": "N/A"},
    "supertrend": {"value": "N/A", "signal": "N/A"},
    "marketBias": "Bullish",
    "sectorOutlook": "N/A",
    "atr": "150",
    "dailyRange": "49800-50200",
    "ivPercentile": "N/A",
    "indiaVix": "N/A",
    "entryWindow": "50000-50050",
    "timeStop": "${maxHold === 'day' ? '3:15 PM' : maxHold === '5m' ? '5 mins' : maxHold === '15m' ? '15 mins' : maxHold === '1h' ? '1 hour' : 'EOD'}",
    "probT1": "65%",
    "probT2": "45%",
    "probT3": "25%",
    "probSL": "30%",
    "marketPhase": "Markup",
    "tradeGrade": "A",
    "existingPositionAdvice": {
        "recommendation": "HOLD / BOOK_PROFIT / BOOK_PARTIAL / CUT_LOSS / N/A",
        "reason": "Why this recommendation based on chart",
        "probabilityOfProfit": "60%",
        "suggestedExitLevel": "price level to exit",
        "timeDecayImpact": "Low/Medium/High/Critical"
    },
    "checklist": [
        {"item": "Trend alignment", "status": "pass"},
        {"item": "Pattern visible", "status": "pass"},
        {"item": "Volume confirmation", "status": "warn"},
        {"item": "R:R ratio good", "status": "pass"},
        {"item": "Not overbought", "status": "pass"},
        {"item": "Clear S/R levels", "status": "pass"},
        {"item": "Momentum aligned", "status": "pass"},
        {"item": "Entry timing", "status": "pass"},
        {"item": "SL at logical level", "status": "pass"},
        {"item": "Target achievable", "status": "pass"}
    ],
    "analysis": "Detailed 2-3 paragraph analysis explaining: 1) EXACTLY what price action and patterns you observe, 2) WHY you chose these specific entry/target/SL levels based on chart structure, 3) Key risks and what would invalidate this setup. 4) If existing position provided, give specific advice on whether to hold, book profit, or cut loss."
}
${existingPosAnalysis}
IMPORTANT: 
- Entry MUST be ${referencePrice} (the current price provided)
- Adjust targets based on whether you recommend LONG or SHORT
- For LONG: targets are above entry, SL is below
- For SHORT: targets are below entry, SL is above
- BE OBJECTIVE: If chart shows bearish signals, recommend SHORT. Don't always default to LONG.

Return ONLY the JSON object, no other text.`;

            try {
                // Use Gemini API (FREE) with fallback to OpenAI
                console.log('Starting chart analysis with AI...');
                
                // Build the full prompt with system instructions
                const systemPrompt = `You are an elite technical analyst with 25+ years of experience. You are UNBIASED and recommend SHORT/SELL just as readily as LONG/BUY based on chart evidence.

CRITICAL BIAS RULE:
- If you see BEARISH signals (lower highs, breakdown, resistance rejection, bearish divergence, overbought RSI, death cross, distribution), you MUST recommend SHORT
- If you see BULLISH signals (higher lows, breakout, support bounce, bullish divergence, oversold RSI, golden cross, accumulation), recommend LONG
- If signals are mixed or unclear, recommend WAIT
- Do NOT default to LONG/BUY. Be objective.

BEARISH PATTERNS (Recommend SHORT):
- Head & Shoulders (completed), Double/Triple Top
- Descending Triangle, Rising Wedge (bearish)
- Evening Star, Shooting Star, Bearish Engulfing
- Break below support, Lower highs forming
- RSI > 70 with bearish divergence
- MACD bearish crossover, Death cross on MA

BULLISH PATTERNS (Recommend LONG):
- Inverse Head & Shoulders, Double/Triple Bottom
- Ascending Triangle, Falling Wedge (bullish)
- Morning Star, Hammer, Bullish Engulfing
- Break above resistance, Higher lows forming
- RSI < 30 with bullish divergence
- MACD bullish crossover, Golden cross on MA

NEUTRAL/WAIT:
- Symmetrical triangle (wait for breakout)
- Ranging/sideways with no clear direction
- Mixed signals from indicators
- Key level test without confirmation

Analyze objectively and give SHORT recommendations when bearish evidence exists.
IMPORTANT: Return ONLY valid JSON, no markdown, no code blocks, no explanation text.`;

                const fullPrompt = systemPrompt + '\n\n' + prompt;
                
                // Try Gemini API first (FREE)
                let content = null;
                let usedModel = 'gemini';
                
                try {
                    const geminiResponse = await fetch('/api/gemini/analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            prompt: fullPrompt,
                            imageBase64: uploadedImageBase64
                        })
                    });
                    
                    if (geminiResponse.ok) {
                        const geminiData = await geminiResponse.json();
                        if (geminiData.success && geminiData.content) {
                            content = geminiData.content;
                            console.log('Gemini API response received');
                        } else if (geminiData.error) {
                            throw new Error(geminiData.error);
                        }
                    } else {
                        const errorData = await geminiResponse.json().catch(() => ({}));
                        throw new Error(errorData.error || `Gemini API error: ${geminiResponse.status}`);
                    }
                } catch (geminiError) {
                    console.log('Gemini API failed:', geminiError.message);
                    
                    // Try OpenAI as fallback
                    try {
                        console.log('Trying OpenAI fallback...');
                        usedModel = 'openai';
                        
                        const openaiResponse = await fetch('/api/openai/chat', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                model: 'gpt-4o-2024-11-20',
                                response_format: { type: "json_object" },
                                messages: [
                                    { role: 'system', content: systemPrompt },
                                    { role: 'user', content: [{ type: 'text', text: prompt }, { type: 'image_url', image_url: { url: uploadedImageBase64, detail: 'high' } }] }
                                ],
                                max_tokens: 4500,
                                temperature: 0
                            })
                        });
                        
                        if (openaiResponse.ok) {
                            const openaiData = await openaiResponse.json();
                            if (openaiData.choices && openaiData.choices[0] && openaiData.choices[0].message) {
                                content = openaiData.choices[0].message.content;
                                console.log('OpenAI fallback successful');
                            }
                        }
                    } catch (openaiError) {
                        console.log('OpenAI fallback also failed:', openaiError.message);
                    }
                    
                    // If both failed, show helpful error
                    if (!content) {
                        throw new Error(`AI Analysis Failed: ${geminiError.message}\n\nTo fix this:\n1. Get a FREE Gemini API key at: https://aistudio.google.com/app/apikey\n2. Add it to your .env file as GEMINI_API_KEY=your_key\n3. Restart the server`);
                    }
                }
                
                console.log('AI Response received from:', usedModel);
                console.log('Raw content:', content.substring(0, 500) + '...');
                
                // Check if response is empty
                if (!content || content.trim().length === 0) {
                    throw new Error('AI returned empty response. Please try with a clearer chart image.');
                }
                
                // Check if AI refused the request
                const refusalPhrases = ["i cannot analyze this image", "i'm not able to analyze", "unable to process this image", "cannot identify a chart", "not a trading chart", "doesn't appear to be a chart", "i don't see a chart", "no chart visible"];
                const contentLower = content.toLowerCase();
                const isRefusal = refusalPhrases.some(phrase => contentLower.includes(phrase));
                
                if (isRefusal && !content.includes('{')) {
                    throw new Error('Unable to analyze this chart. Please try:\n‚Ä¢ A cleaner chart screenshot (without extra overlays)\n‚Ä¢ Cropping to show only the price chart\n‚Ä¢ Using a chart from a standard trading platform');
                }
                
                let analysis;
                
                try {
                    // Try to extract JSON from the response
                    let jsonStr = content.trim();
                    
                    // Remove markdown code blocks if present
                    jsonStr = jsonStr.replace(/```json\s*/gi, '').replace(/```\s*/gi, '').trim();
                    
                    // Try direct parse first (since we're using response_format: json_object)
                    try {
                        analysis = JSON.parse(jsonStr);
                    } catch (directParseError) {
                        // Fallback: try to find JSON object in the response
                        const jsonMatch = jsonStr.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            analysis = JSON.parse(jsonMatch[0]);
                        } else {
                            throw new Error('No valid JSON found');
                        }
                    }
                    
                    // Validate that we got essential fields
                    if (!analysis.signal && !analysis.entry && !analysis.trend) {
                        console.warn('Missing essential fields in response:', analysis);
                        // Try to salvage what we can
                        analysis = {
                            signal: analysis.signal || 'NEUTRAL',
                            confidence: analysis.confidence || 60,
                            tradeType: analysis.tradeType || 'WAIT',
                            entry: analysis.entry || analysis.currentPrice || analysis.price || 'Unable to determine',
                            target1: analysis.target1 || analysis.t1 || 'N/A',
                            target2: analysis.target2 || analysis.t2 || 'N/A',
                            target3: analysis.target3 || analysis.t3 || 'N/A',
                            stopLoss: analysis.stopLoss || analysis.sl || analysis.stop || 'N/A',
                            riskRewardRatio: analysis.riskRewardRatio || analysis.rr || 'N/A',
                            pattern: analysis.pattern || 'Not identified',
                            patternReliability: analysis.patternReliability || 'Medium',
                            trend: analysis.trend || 'Sideways',
                            trendStrength: analysis.trendStrength || 'Moderate',
                            momentum: analysis.momentum || 'Neutral',
                            momentumNote: analysis.momentumNote || '',
                            volume: analysis.volume || 'Not Visible',
                            volumeNote: analysis.volumeNote || '',
                            tradeHorizon: analysis.tradeHorizon || 'Intraday',
                            expectedMove: analysis.expectedMove || 'N/A',
                            winProbability: analysis.winProbability || '50%',
                            volatility: analysis.volatility || 'Medium',
                            setupQuality: analysis.setupQuality || 'B',
                            riskLevel: analysis.riskLevel || 3,
                            rsi: analysis.rsi || { value: 'N/A', signal: 'NEUTRAL' },
                            macd: analysis.macd || { value: 'N/A', signal: 'NEUTRAL' },
                            movingAverage: analysis.movingAverage || { value: 'N/A', signal: 'NEUTRAL' },
                            vwap: analysis.vwap || { value: 'N/A', signal: 'N/A' },
                            stochastic: analysis.stochastic || { value: 'N/A', signal: 'NEUTRAL' },
                            bollinger: analysis.bollinger || { value: 'N/A', signal: 'N/A' },
                            adx: analysis.adx || { value: 'N/A', signal: 'N/A' },
                            supertrend: analysis.supertrend || { value: 'N/A', signal: 'N/A' },
                            marketBias: analysis.marketBias || 'Neutral',
                            sectorOutlook: analysis.sectorOutlook || 'N/A',
                            atr: analysis.atr || 'N/A',
                            dailyRange: analysis.dailyRange || 'N/A',
                            ivPercentile: analysis.ivPercentile || 'N/A',
                            indiaVix: analysis.indiaVix || 'N/A',
                            entryWindow: analysis.entryWindow || 'N/A',
                            timeStop: analysis.timeStop || 'N/A',
                            probT1: analysis.probT1 || '60%',
                            probT2: analysis.probT2 || '40%',
                            probT3: analysis.probT3 || '25%',
                            probSL: analysis.probSL || '35%',
                            marketPhase: analysis.marketPhase || 'N/A',
                            tradeGrade: analysis.tradeGrade || 'B',
                            checklist: analysis.checklist || [],
                            analysis: analysis.analysis || analysis.summary || analysis.description || 'Chart analysis completed. Review the levels above.'
                        };
                    }
                } catch (e) {
                    console.error('JSON parse failed:', e, 'Content:', content);
                    throw new Error('Unable to parse chart analysis. The AI response was not in the expected format. Please try again with a clearer chart image.');
                }
                
                // FORCE CORRECT: Always use user-provided reference price
                const isLong = analysis.tradeType === 'LONG' || analysis.signal === 'BULLISH';
                const isShort = analysis.tradeType === 'SHORT' || analysis.signal === 'BEARISH';
                const limits = realisticMoves[assetType]?.[tradingStyle] || realisticMoves['index']['daytrader'];
                
                // Always set entry to user-provided reference price
                analysis.entry = referencePrice.toFixed(2);
                
                // Calculate targets based on reference price and trade direction
                if (isLong) {
                    analysis.target1 = (referencePrice * (1 + limits.t1/100)).toFixed(2);
                    analysis.target2 = (referencePrice * (1 + limits.t2/100)).toFixed(2);
                    analysis.target3 = (referencePrice * (1 + limits.t3/100)).toFixed(2);
                    analysis.stopLoss = (referencePrice * (1 - limits.sl/100)).toFixed(2);
                } else if (isShort) {
                    analysis.target1 = (referencePrice * (1 - limits.t1/100)).toFixed(2);
                    analysis.target2 = (referencePrice * (1 - limits.t2/100)).toFixed(2);
                    analysis.target3 = (referencePrice * (1 - limits.t3/100)).toFixed(2);
                    analysis.stopLoss = (referencePrice * (1 + limits.sl/100)).toFixed(2);
                } else {
                    // WAIT/NEUTRAL - still provide levels for reference
                    analysis.target1 = (referencePrice * (1 + limits.t1/100)).toFixed(2);
                    analysis.target2 = (referencePrice * (1 + limits.t2/100)).toFixed(2);
                    analysis.target3 = (referencePrice * (1 + limits.t3/100)).toFixed(2);
                    analysis.stopLoss = (referencePrice * (1 - limits.sl/100)).toFixed(2);
                }
                
                // Calculate Risk:Reward ratio
                const risk = Math.abs(referencePrice - parseFloat(analysis.stopLoss));
                const reward = Math.abs(parseFloat(analysis.target3) - referencePrice);
                analysis.riskRewardRatio = risk > 0 ? `1:${(reward/risk).toFixed(1)}` : '1:2';
                
                // Set entry window
                analysis.entryWindow = `${(referencePrice * 0.999).toFixed(2)} - ${(referencePrice * 1.001).toFixed(2)}`;
                analysis.dailyRange = `${(referencePrice * 0.99).toFixed(2)} - ${(referencePrice * 1.01).toFixed(2)}`;
                
                console.log('Final analysis with corrected prices:', {
                    entry: analysis.entry,
                    t1: analysis.target1,
                    t2: analysis.target2,
                    t3: analysis.target3,
                    sl: analysis.stopLoss,
                    direction: isLong ? 'LONG' : isShort ? 'SHORT' : 'WAIT'
                });
                
                // VALIDATE AND CORRECT UNREALISTIC TARGETS
                analysis = validateAndCorrectTargets(analysis, assetType, tradingStyle, maxHold);
                
                currentAnalysis = analysis;
                displayResults(analysis, capital, riskPercent);
                
            } catch (error) {
                console.error('Error:', error);
                
                // Create user-friendly error message
                let userMessage = error.message;
                let tips = '';
                
                if (error.message.includes('API key not configured') || error.message.includes('GEMINI_API_KEY')) {
                    tips = '\n\nüîë Setup Required:\n1. Get a FREE API key at: https://aistudio.google.com/app/apikey\n2. Add to your .env file: GEMINI_API_KEY=your_key_here\n3. Restart the server with: npm start';
                } else if (error.message.includes('quota') || error.message.includes('rate limit') || error.message.includes('capacity') || error.message.includes('RESOURCE_EXHAUSTED')) {
                    tips = '\n\n‚è≥ Rate limit reached (15 requests/minute for free tier). Please wait 60 seconds and try again.';
                } else if (error.message.includes('image') || error.message.includes('chart')) {
                    tips = '\n\nüì∏ Tips for better results:\n‚Ä¢ Use a clear screenshot from TradingView, Zerodha, or similar\n‚Ä¢ Make sure candles/bars are clearly visible\n‚Ä¢ Avoid images with personal info or watermarks\n‚Ä¢ Try PNG or JPEG format';
                } else if (error.message.includes('authentication') || error.message.includes('INVALID_ARGUMENT') || error.message.includes('API_KEY_INVALID')) {
                    tips = '\n\nüîß Invalid API key. Please check your GEMINI_API_KEY in the .env file.\nGet a new key at: https://aistudio.google.com/app/apikey';
                } else {
                    tips = '\n\nüí° Tips:\n‚Ä¢ Use a clear, high-quality chart image\n‚Ä¢ Make sure the chart shows price candles/bars\n‚Ä¢ Try a different timeframe\n‚Ä¢ Crop to show only the chart area';
                }
                
                alert('Analysis failed: ' + userMessage + tips);
            } finally {
                analyzeBtn.classList.remove('loading');
                analyzeBtn.disabled = false;
            }
        }
        
        // Function to validate and correct unrealistic targets
        function validateAndCorrectTargets(analysis, assetType, tradingStyle, maxHold) {
            const entry = parseFloat(analysis.entry);
            if (!entry || isNaN(entry)) return analysis;
            
            // Maximum allowed percentages based on trading style and hold time
            const maxPercentages = {
                'scalper': { t1: 0.2, t2: 0.35, t3: 0.5, sl: 0.15 },
                'daytrader': { t1: 0.5, t2: 0.8, t3: 1.2, sl: 0.3 },
                'swing': { t1: 2.0, t2: 3.5, t3: 5.0, sl: 1.5 }
            };
            
            // Adjust for asset type
            const assetMultipliers = {
                'index': 0.8,      // Indices move less
                'stock': 1.0,
                'crypto': 2.5,    // Crypto is more volatile
                'forex': 0.3,     // Forex moves in pips
                'commodity': 1.0,
                'options': 3.0    // Options can move more
            };
            
            // Adjust for max hold time
            const holdMultipliers = {
                '5m': 0.3,
                '15m': 0.5,
                '1h': 0.7,
                'day': 1.0,
                'swing': 2.0,
                'position': 3.0
            };
            
            const limits = maxPercentages[tradingStyle] || maxPercentages['daytrader'];
            const assetMult = assetMultipliers[assetType] || 1.0;
            const holdMult = holdMultipliers[maxHold] || 1.0;
            
            // Calculate max allowed moves
            const maxT1Pct = limits.t1 * assetMult * holdMult;
            const maxT2Pct = limits.t2 * assetMult * holdMult;
            const maxT3Pct = limits.t3 * assetMult * holdMult;
            const maxSLPct = limits.sl * assetMult * holdMult;
            
            let t1 = parseFloat(analysis.target1);
            let t2 = parseFloat(analysis.target2);
            let t3 = parseFloat(analysis.target3);
            let sl = parseFloat(analysis.stopLoss);
            
            const isLong = analysis.tradeType === 'LONG';
            let corrected = false;
            
            // Validate and correct each target
            if (!isNaN(t1)) {
                const t1Pct = Math.abs((t1 - entry) / entry * 100);
                if (t1Pct > maxT1Pct) {
                    t1 = isLong ? entry * (1 + maxT1Pct / 100) : entry * (1 - maxT1Pct / 100);
                    corrected = true;
                    console.log(`T1 corrected from ${analysis.target1} to ${t1.toFixed(2)} (was ${t1Pct.toFixed(2)}%, max ${maxT1Pct.toFixed(2)}%)`);
                }
            }
            
            if (!isNaN(t2)) {
                const t2Pct = Math.abs((t2 - entry) / entry * 100);
                if (t2Pct > maxT2Pct) {
                    t2 = isLong ? entry * (1 + maxT2Pct / 100) : entry * (1 - maxT2Pct / 100);
                    corrected = true;
                    console.log(`T2 corrected from ${analysis.target2} to ${t2.toFixed(2)} (was ${t2Pct.toFixed(2)}%, max ${maxT2Pct.toFixed(2)}%)`);
                }
            }
            
            if (!isNaN(t3)) {
                const t3Pct = Math.abs((t3 - entry) / entry * 100);
                if (t3Pct > maxT3Pct) {
                    t3 = isLong ? entry * (1 + maxT3Pct / 100) : entry * (1 - maxT3Pct / 100);
                    corrected = true;
                    console.log(`T3 corrected from ${analysis.target3} to ${t3.toFixed(2)} (was ${t3Pct.toFixed(2)}%, max ${maxT3Pct.toFixed(2)}%)`);
                }
            }
            
            if (!isNaN(sl)) {
                const slPct = Math.abs((sl - entry) / entry * 100);
                if (slPct > maxSLPct) {
                    sl = isLong ? entry * (1 - maxSLPct / 100) : entry * (1 + maxSLPct / 100);
                    corrected = true;
                    console.log(`SL corrected from ${analysis.stopLoss} to ${sl.toFixed(2)} (was ${slPct.toFixed(2)}%, max ${maxSLPct.toFixed(2)}%)`);
                }
            }
            
            // Update analysis with corrected values
            if (corrected) {
                analysis.target1 = t1.toFixed(2);
                analysis.target2 = t2.toFixed(2);
                analysis.target3 = t3.toFixed(2);
                analysis.stopLoss = sl.toFixed(2);
                
                // Recalculate Risk:Reward
                const risk = Math.abs(entry - sl);
                const reward1 = Math.abs(t1 - entry);
                const reward3 = Math.abs(t3 - entry);
                const rr = risk > 0 ? (reward3 / risk).toFixed(1) : 'N/A';
                analysis.riskRewardRatio = `1:${rr}`;
                
                // Add note about correction
                analysis.analysis = `‚ö†Ô∏è NOTE: Targets were auto-adjusted to be realistic for ${tradingStyle} style with ${maxHold} holding period.\n\n` + (analysis.analysis || '');
                
                console.log('Targets corrected for realistic expectations:', { t1, t2, t3, sl, rr });
            }
            
            return analysis;
        }
        
        function displayResults(analysis, capital, riskPercent) {
            const resultsSection = document.getElementById('resultsSection');
            resultsSection.classList.add('visible');
            
            const signal = analysis.signal?.toUpperCase() || 'NEUTRAL';
            const signalClass = signal === 'BULLISH' ? 'bullish' : signal === 'BEARISH' ? 'bearish' : 'neutral';
            const signalIcon = signal === 'BULLISH' ? 'fa-arrow-up' : signal === 'BEARISH' ? 'fa-arrow-down' : 'fa-arrows-left-right';
            
            document.getElementById('signalBox').className = `signal-box ${signalClass}`;
            document.getElementById('signalValue').className = `signal-value ${signalClass}`;
            document.getElementById('signalValue').innerHTML = `<i class="fas ${signalIcon}"></i> <span>${signal}</span>`;
            
            const confidence = analysis.confidence || 70;
            document.getElementById('confidencePercent').textContent = confidence + '%';
            document.getElementById('confidenceCircle').style.setProperty('--confidence', confidence);
            
            const tradeType = analysis.tradeType || 'WAIT';
            const tradeBadge = document.getElementById('tradeBadge');
            tradeBadge.className = `trade-badge ${tradeType.toLowerCase() === 'long' ? 'long' : tradeType.toLowerCase() === 'short' ? 'short' : 'wait'}`;
            tradeBadge.textContent = tradeType === 'LONG' ? 'GO LONG' : tradeType === 'SHORT' ? 'GO SHORT' : 'WAIT';
            
            // Display Existing Position Advice if available
            const existingPosAdvice = analysis.existingPositionAdvice;
            const adviceBox = document.getElementById('existingPositionAdviceBox');
            if (existingPosAdvice && existingPosAdvice.recommendation && existingPosAdvice.recommendation !== 'N/A') {
                adviceBox.style.display = 'block';
                
                const rec = existingPosAdvice.recommendation?.toUpperCase() || 'N/A';
                const recEl = document.getElementById('existingAdviceRec');
                
                if (rec.includes('HOLD')) {
                    recEl.style.color = '#3b82f6';
                    recEl.textContent = 'üîÑ HOLD';
                } else if (rec.includes('PROFIT') || rec.includes('BOOK')) {
                    recEl.style.color = '#22c55e';
                    recEl.textContent = 'üí∞ BOOK PROFIT';
                } else if (rec.includes('LOSS') || rec.includes('CUT') || rec.includes('EXIT')) {
                    recEl.style.color = '#ef4444';
                    recEl.textContent = 'üõë EXIT/CUT LOSS';
                } else if (rec.includes('PARTIAL')) {
                    recEl.style.color = '#f59e0b';
                    recEl.textContent = 'üìä BOOK PARTIAL';
                } else {
                    recEl.style.color = '#888';
                    recEl.textContent = rec;
                }
                
                document.getElementById('existingAdviceProb').textContent = existingPosAdvice.probabilityOfProfit || 'N/A';
                document.getElementById('existingAdviceExit').textContent = existingPosAdvice.suggestedExitLevel || 'N/A';
                
                const theta = existingPosAdvice.timeDecayImpact?.toUpperCase() || 'N/A';
                const thetaEl = document.getElementById('existingAdviceTheta');
                if (theta.includes('CRITICAL') || theta.includes('HIGH')) {
                    thetaEl.style.color = '#ef4444';
                    thetaEl.textContent = 'üî• ' + theta;
                } else if (theta.includes('MEDIUM')) {
                    thetaEl.style.color = '#f59e0b';
                    thetaEl.textContent = '‚ö†Ô∏è ' + theta;
                } else {
                    thetaEl.style.color = '#22c55e';
                    thetaEl.textContent = '‚úÖ ' + theta;
                }
                
                document.getElementById('existingAdviceReason').textContent = existingPosAdvice.reason || 'Based on current chart analysis';
            } else {
                adviceBox.style.display = 'none';
            }
            
            document.getElementById('entryLevel').textContent = analysis.entry || '--';
            document.getElementById('target1Level').textContent = analysis.target1 || '--';
            document.getElementById('target2Level').textContent = analysis.target2 || '--';
            document.getElementById('target3Level').textContent = analysis.target3 || '--';
            document.getElementById('stopLevel').textContent = analysis.stopLoss || '--';
            
            // Quick Summary
            document.getElementById('quickEntry').textContent = analysis.entry || '--';
            document.getElementById('quickSL').textContent = analysis.stopLoss || '--';
            document.getElementById('quickT1').textContent = analysis.target1 || '--';
            document.getElementById('quickRR').textContent = analysis.riskRewardRatio || '--';
            document.getElementById('quickWinProb').textContent = analysis.winProbability || '--';
            
            const entry = parseFloat(analysis.entry) || 0;
            const isShortTrade = analysis.tradeType === 'SHORT' || analysis.signal === 'BEARISH';
            if (entry > 0) {
                const t1 = parseFloat(analysis.target1) || 0;
                const t2 = parseFloat(analysis.target2) || 0;
                const t3 = parseFloat(analysis.target3) || 0;
                const sl = parseFloat(analysis.stopLoss) || 0;
                
                // For SHORT trades, targets are below entry but represent profit, so show as positive
                if (t1) {
                    const t1Pct = Math.abs((t1 - entry) / entry * 100).toFixed(2);
                    document.getElementById('target1Pct').textContent = '+' + t1Pct + '%';
                }
                if (t2) {
                    const t2Pct = Math.abs((t2 - entry) / entry * 100).toFixed(2);
                    document.getElementById('target2Pct').textContent = '+' + t2Pct + '%';
                }
                if (t3) {
                    const t3Pct = Math.abs((t3 - entry) / entry * 100).toFixed(2);
                    document.getElementById('target3Pct').textContent = '+' + t3Pct + '%';
                }
                if (sl) {
                    // Stop loss is always a loss, so show as negative
                    const slPct = Math.abs((sl - entry) / entry * 100).toFixed(2);
                    document.getElementById('stopPct').textContent = '-' + slPct + '%';
                }
                
                // Adjust risk based on live India VIX
                const adjustedRiskPercent = getVIXAdjustedRisk(riskPercent);
                const riskAmount = capital * (adjustedRiskPercent / 100);
                const riskPerShare = Math.abs(entry - sl);
                let positionSize = riskPerShare > 0 ? Math.floor(riskAmount / riskPerShare) : 0;
                const lotSize = parseFloat(document.getElementById('calcLotSize').value) || 1;
                positionSize = Math.floor(positionSize / lotSize) * lotSize;
                
                // Show VIX-adjusted risk info
                if (liveIndiaVIX && adjustedRiskPercent !== riskPercent) {
                    const vixNote = document.getElementById('vixInterpretation');
                    if (vixNote) {
                        const vixInfo = getVIXInterpretation(liveIndiaVIX.value);
                        vixNote.innerHTML = `${vixInfo.mood} <br><small style="color:#888;">Risk adjusted: ${riskPercent}% ‚Üí ${adjustedRiskPercent.toFixed(2)}%</small>`;
                    }
                }
                
                document.getElementById('calcRiskAmount').value = riskAmount.toFixed(0);
                document.getElementById('positionSize').textContent = positionSize;
                document.getElementById('quickQty').textContent = positionSize;
                document.getElementById('capitalRequired').textContent = '‚Çπ' + (positionSize * entry).toLocaleString('en-IN');
                document.getElementById('maxLoss').textContent = '‚Çπ' + (positionSize * riskPerShare).toLocaleString('en-IN');
                document.getElementById('maxProfit').textContent = '‚Çπ' + (positionSize * Math.abs(t3 - entry)).toLocaleString('en-IN');
                
                const reward = t3 - entry;
                const risk = Math.abs(entry - sl);
                const rrRatio = risk > 0 ? (reward / risk).toFixed(1) : 0;
                document.getElementById('rrRatio').textContent = `1:${rrRatio}`;
                
                const riskPct = 100 / (1 + parseFloat(rrRatio));
                document.getElementById('rrRiskBar').style.width = riskPct + '%';
                document.getElementById('rrRewardBar').style.width = (100 - riskPct) + '%';
                
                document.getElementById('rrRiskAmount').textContent = '‚Çπ' + (positionSize * riskPerShare).toLocaleString('en-IN');
                document.getElementById('rrRewardT1').textContent = '‚Çπ' + (positionSize * Math.abs(t1 - entry)).toLocaleString('en-IN');
                document.getElementById('rrRewardT3').textContent = '‚Çπ' + (positionSize * Math.abs(t3 - entry)).toLocaleString('en-IN');
            }
            
            document.getElementById('patternName').textContent = analysis.pattern || '--';
            document.getElementById('patternReliability').textContent = analysis.patternReliability ? `${analysis.patternReliability} reliability` : '--';
            
            const trendEl = document.getElementById('trendDirection');
            trendEl.textContent = analysis.trend || '--';
            trendEl.style.color = analysis.trend?.toLowerCase().includes('up') ? 'var(--green)' : analysis.trend?.toLowerCase().includes('down') ? 'var(--red)' : 'var(--orange)';
            document.getElementById('trendStrength').textContent = analysis.trendStrength || '--';
            
            document.getElementById('momentum').textContent = analysis.momentum || '--';
            document.getElementById('momentumNote').textContent = analysis.momentumNote || '--';
            document.getElementById('volumeAnalysis').textContent = analysis.volume || '--';
            document.getElementById('volumeNote').textContent = analysis.volumeNote || '--';
            
            document.getElementById('tradeHorizon').textContent = analysis.tradeHorizon || '--';
            document.getElementById('expectedMove').textContent = analysis.expectedMove || '--';
            document.getElementById('winProbability').textContent = analysis.winProbability || '--';
            document.getElementById('volatility').textContent = analysis.volatility || '--';
            document.getElementById('breakeven').textContent = analysis.entry || '--';
            document.getElementById('setupQuality').textContent = analysis.setupQuality || '--';
            
            if (analysis.rsi) {
                document.getElementById('rsiValue').textContent = analysis.rsi.value || '--';
                const rsiSignal = document.getElementById('rsiSignal');
                rsiSignal.textContent = analysis.rsi.signal || '--';
                rsiSignal.className = `indicator-signal ${analysis.rsi.signal?.toLowerCase() === 'buy' ? 'buy' : analysis.rsi.signal?.toLowerCase() === 'sell' ? 'sell' : 'neutral'}`;
            }
            if (analysis.macd) {
                document.getElementById('macdValue').textContent = analysis.macd.value || '--';
                const macdSignal = document.getElementById('macdSignal');
                macdSignal.textContent = analysis.macd.signal || '--';
                macdSignal.className = `indicator-signal ${analysis.macd.signal?.toLowerCase() === 'buy' ? 'buy' : analysis.macd.signal?.toLowerCase() === 'sell' ? 'sell' : 'neutral'}`;
            }
            if (analysis.movingAverage) {
                document.getElementById('maValue').textContent = analysis.movingAverage.value || '--';
                const maSignal = document.getElementById('maSignal');
                maSignal.textContent = analysis.movingAverage.signal || '--';
                maSignal.className = `indicator-signal ${analysis.movingAverage.signal?.toLowerCase() === 'buy' ? 'buy' : analysis.movingAverage.signal?.toLowerCase() === 'sell' ? 'sell' : 'neutral'}`;
            }
            if (analysis.vwap) {
                document.getElementById('vwapValue').textContent = analysis.vwap.value || '--';
                const vwapSignal = document.getElementById('vwapSignal');
                vwapSignal.textContent = analysis.vwap.signal || '--';
                vwapSignal.className = `indicator-signal ${analysis.vwap.signal?.toLowerCase() === 'buy' ? 'buy' : analysis.vwap.signal?.toLowerCase() === 'sell' ? 'sell' : 'neutral'}`;
            }
            
            // Additional indicators
            if (analysis.stochastic) {
                document.getElementById('stochValue').textContent = analysis.stochastic.value || '--';
                const stochSignal = document.getElementById('stochSignal');
                stochSignal.textContent = analysis.stochastic.signal || '--';
                stochSignal.className = `indicator-signal ${analysis.stochastic.signal?.toLowerCase() === 'buy' ? 'buy' : analysis.stochastic.signal?.toLowerCase() === 'sell' ? 'sell' : 'neutral'}`;
            }
            if (analysis.bollinger) {
                document.getElementById('bollingerValue').textContent = analysis.bollinger.value || '--';
                const bollingerSignal = document.getElementById('bollingerSignal');
                bollingerSignal.textContent = analysis.bollinger.signal || '--';
                bollingerSignal.className = `indicator-signal ${analysis.bollinger.signal?.toLowerCase() === 'buy' ? 'buy' : analysis.bollinger.signal?.toLowerCase() === 'sell' ? 'sell' : 'neutral'}`;
            }
            if (analysis.adx) {
                document.getElementById('adxValue').textContent = analysis.adx.value || '--';
                const adxSignal = document.getElementById('adxSignal');
                adxSignal.textContent = analysis.adx.signal || '--';
                adxSignal.className = `indicator-signal ${analysis.adx.signal?.toLowerCase() === 'strong' ? 'buy' : analysis.adx.signal?.toLowerCase() === 'weak' ? 'sell' : 'neutral'}`;
            }
            if (analysis.supertrend) {
                document.getElementById('supertrendValue').textContent = analysis.supertrend.value || '--';
                const supertrendSignal = document.getElementById('supertrendSignal');
                supertrendSignal.textContent = analysis.supertrend.signal || '--';
                supertrendSignal.className = `indicator-signal ${analysis.supertrend.signal?.toLowerCase() === 'buy' ? 'buy' : analysis.supertrend.signal?.toLowerCase() === 'sell' ? 'sell' : 'neutral'}`;
            }
            
            // Market Context
            document.getElementById('marketPhase').textContent = analysis.marketPhase || '--';
            document.getElementById('trendStrengthVal').textContent = analysis.trendStrength || '--';
            document.getElementById('sectorOutlook').textContent = analysis.sectorOutlook || '--';
            document.getElementById('marketBias').textContent = analysis.marketBias || '--';
            
            const checklistGrid = document.getElementById('checklistGrid');
            checklistGrid.innerHTML = '';
            if (analysis.checklist && analysis.checklist.length > 0) {
                analysis.checklist.forEach(item => {
                    const iconClass = item.status === 'pass' ? 'pass' : item.status === 'fail' ? 'fail' : 'warn';
                    const icon = item.status === 'pass' ? 'fa-check' : item.status === 'fail' ? 'fa-times' : 'fa-exclamation';
                    checklistGrid.innerHTML += `<div class="checklist-item"><div class="checklist-icon ${iconClass}"><i class="fas ${icon}"></i></div><div class="checklist-text">${item.item}</div></div>`;
                });
            }
            
            document.getElementById('detailedText').innerHTML = `<p>${(analysis.analysis || 'No analysis available.').replace(/\n/g, '</p><p>')}</p>`;
            
            const riskLevel = Math.min(5, Math.max(1, analysis.riskLevel || 3));
            document.querySelectorAll('.risk-segment').forEach((seg, i) => {
                seg.classList.remove('active');
                if (i < riskLevel) seg.classList.add('active');
            });
            
            const riskBadge = document.getElementById('riskBadge');
            riskBadge.textContent = riskLevel <= 2 ? 'LOW' : riskLevel <= 3 ? 'MODERATE' : 'HIGH';
            riskBadge.className = `risk-level-badge ${riskLevel <= 2 ? 'low' : riskLevel <= 3 ? 'medium' : 'high'}`;
            
            // Volatility Section - Use live India VIX if available
            document.getElementById('atrValue').textContent = analysis.atr || '--';
            document.getElementById('dailyRange').textContent = analysis.dailyRange || '--';
            
            // Refresh live India VIX and update display
            if (liveIndiaVIX) {
                updateIndiaVIXDisplay();
            } else {
                fetchIndiaVIX(); // Fetch if not available
            }
            
            // P&L Scenarios
            const leverage = parseFloat(document.getElementById('leverageInput').value) || 1;
            const brokerage = parseFloat(document.getElementById('brokerageInput').value) || 20;
            
            if (entry > 0) {
                const t1 = parseFloat(analysis.target1) || 0;
                const t2 = parseFloat(analysis.target2) || 0;
                const t3 = parseFloat(analysis.target3) || 0;
                const sl = parseFloat(analysis.stopLoss) || 0;
                const posSize = parseFloat(document.getElementById('positionSize').textContent) || 0;
                
                const bestProfit = posSize * Math.abs(t3 - entry);
                const expectedProfit = posSize * Math.abs(t1 - entry);
                const partialProfit = (posSize * 0.5 * Math.abs(t1 - entry)) + (posSize * 0.3 * Math.abs(t2 - entry)) + (posSize * 0.2 * Math.abs(t3 - entry));
                const worstLoss = posSize * Math.abs(entry - sl);
                
                document.getElementById('pnlBest').textContent = '+‚Çπ' + bestProfit.toLocaleString('en-IN', {maximumFractionDigits: 0});
                document.getElementById('pnlExpected').textContent = '+‚Çπ' + expectedProfit.toLocaleString('en-IN', {maximumFractionDigits: 0});
                document.getElementById('pnlPartial').textContent = '+‚Çπ' + partialProfit.toLocaleString('en-IN', {maximumFractionDigits: 0});
                document.getElementById('pnlWorst').textContent = '-‚Çπ' + worstLoss.toLocaleString('en-IN', {maximumFractionDigits: 0});
                
                document.getElementById('pnlBestPct').textContent = '+' + ((bestProfit / capital) * 100).toFixed(2) + '% ROI';
                document.getElementById('pnlExpectedPct').textContent = '+' + ((expectedProfit / capital) * 100).toFixed(2) + '% ROI';
                document.getElementById('pnlPartialPct').textContent = '+' + ((partialProfit / capital) * 100).toFixed(2) + '% ROI';
                document.getElementById('pnlWorstPct').textContent = '-' + ((worstLoss / capital) * 100).toFixed(2) + '% of Capital';
                
                document.getElementById('pnlBestProb').textContent = '~' + (analysis.probT3 || '25%') + ' probability';
                document.getElementById('pnlExpectedProb').textContent = '~' + (analysis.probT1 || '55%') + ' probability';
                document.getElementById('pnlWorstProb').textContent = '~' + (analysis.probSL || '35%') + ' probability';
                
                // Show best trade badge if high probability
                const winProb = parseInt(analysis.winProbability) || 50;
                if (winProb >= 65 && (analysis.tradeGrade === 'A+' || analysis.tradeGrade === 'A')) {
                    document.getElementById('bestTradeTag').style.display = 'inline-flex';
                } else {
                    document.getElementById('bestTradeTag').style.display = 'none';
                }
                
                // Exit Strategy Timeline
                document.getElementById('exitEntry').textContent = analysis.entry || 'Entry';
                document.getElementById('exitT1').textContent = analysis.target1 || 'T1';
                document.getElementById('exitT2').textContent = analysis.target2 || 'T2';
                document.getElementById('exitT3').textContent = analysis.target3 || 'T3';
                document.getElementById('exitSL').textContent = analysis.stopLoss || 'SL';
                
                // Advanced Metrics
                const winProbNum = parseFloat(analysis.winProbability) / 100 || 0.5;
                const avgWin = (t1 - entry) / entry;
                const avgLoss = Math.abs(entry - sl) / entry;
                const kelly = ((winProbNum * avgWin) - ((1 - winProbNum) * avgLoss)) / avgWin;
                document.getElementById('kellyValue').textContent = (kelly * 100).toFixed(1) + '%';
                
                const ev = (winProbNum * expectedProfit) - ((1 - winProbNum) * worstLoss);
                document.getElementById('evValue').textContent = (ev >= 0 ? '+' : '') + '‚Çπ' + ev.toLocaleString('en-IN', {maximumFractionDigits: 0});
                
                const gradeMap = { 'A+': '9.5/10', 'A': '8.5/10', 'B': '7/10', 'C': '5.5/10', 'D': '4/10' };
                document.getElementById('tradeScore').textContent = gradeMap[analysis.tradeGrade] || gradeMap[analysis.setupQuality] || '7/10';
                
                const maxDD = (riskPercent * 5);
                document.getElementById('maxDrawdown').textContent = '-' + maxDD.toFixed(1) + '%';
                
                // Timing Section
                document.getElementById('entryWindow').textContent = analysis.entryWindow || 'After confirmation';
                const holdTimeMap = { '5m': '5 Minutes', '15m': '15 Minutes', '1h': '1 Hour', 'day': 'End of Day', 'swing': '2-5 Days', 'position': '1+ Week' };
                document.getElementById('maxHoldDisplay').textContent = holdTimeMap[document.getElementById('maxHoldTime').value] || 'Same Day';
                document.getElementById('timeStop').textContent = analysis.timeStop || 'Exit by 3:15 PM';
                
                // Cost Analysis
                const turnover = posSize * entry * 2;
                const stt = turnover * 0.0001;
                const exchangeFees = turnover * 0.0000345;
                const gst = (brokerage * 2) * 0.18;
                const totalCost = (brokerage * 2) + stt + exchangeFees + gst;
                
                document.getElementById('costBrokerage').textContent = '‚Çπ' + (brokerage * 2).toFixed(0);
                document.getElementById('costSTT').textContent = '‚Çπ' + stt.toFixed(2);
                document.getElementById('costExchange').textContent = '‚Çπ' + exchangeFees.toFixed(2);
                document.getElementById('costGST').textContent = '‚Çπ' + gst.toFixed(2);
                document.getElementById('costTotal').textContent = '‚Çπ' + totalCost.toFixed(2);
            }
            
            resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        function recalculatePosition() {
            if (!currentAnalysis) return;
            const capital = parseFloat(document.getElementById('calcCapital').value) || 100000;
            const riskPercent = parseFloat(document.getElementById('riskPercent').value) || 1;
            displayResults(currentAnalysis, capital, riskPercent);
        }
        
        function copyAnalysis() {
            if (!currentAnalysis) {
                alert('No analysis to copy. Please analyze a chart first.');
                return;
            }
            
            const capital = parseFloat(document.getElementById('calcCapital').value) || 100000;
            const positionSize = document.getElementById('positionSize').textContent || '--';
            const maxLoss = document.getElementById('maxLoss').textContent || '--';
            const maxProfit = document.getElementById('maxProfit').textContent || '--';
            
            const text = `üéØ AI TRADE SETUP ANALYSIS (Educational Only)
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üìä SIGNAL OVERVIEW:
‚Ä¢ Signal: ${currentAnalysis.signal || 'N/A'} (${currentAnalysis.confidence || 'N/A'}% confidence)
‚Ä¢ Recommended Action: ${currentAnalysis.tradeType || 'N/A'}
‚Ä¢ Setup Quality: ${currentAnalysis.setupQuality || 'N/A'}
‚Ä¢ Win Probability: ${currentAnalysis.winProbability || 'N/A'}

üìç KEY PRICE LEVELS:
‚Ä¢ Entry: ${currentAnalysis.entry || 'N/A'}
‚Ä¢ Target 1: ${currentAnalysis.target1 || 'N/A'}
‚Ä¢ Target 2: ${currentAnalysis.target2 || 'N/A'}
‚Ä¢ Target 3: ${currentAnalysis.target3 || 'N/A'}
‚Ä¢ Stop Loss: ${currentAnalysis.stopLoss || 'N/A'}

‚öñÔ∏è RISK MANAGEMENT:
‚Ä¢ Risk:Reward Ratio: ${currentAnalysis.riskRewardRatio || 'N/A'}
‚Ä¢ Position Size: ${positionSize} units
‚Ä¢ Max Loss (if SL hit): ${maxLoss}
‚Ä¢ Max Profit (at T3): ${maxProfit}

üìê TECHNICAL ANALYSIS:
‚Ä¢ Pattern Detected: ${currentAnalysis.pattern || 'N/A'}
‚Ä¢ Pattern Reliability: ${currentAnalysis.patternReliability || 'N/A'}
‚Ä¢ Market Trend: ${currentAnalysis.trend || 'N/A'} (${currentAnalysis.trendStrength || 'N/A'})
‚Ä¢ Momentum: ${currentAnalysis.momentum || 'N/A'}
‚Ä¢ Volatility: ${currentAnalysis.volatility || 'N/A'}
‚Ä¢ Trade Horizon: ${currentAnalysis.tradeHorizon || 'N/A'}

üìä INDICATORS:
‚Ä¢ RSI: ${currentAnalysis.rsi?.value || 'N/A'} (${currentAnalysis.rsi?.signal || 'N/A'})
‚Ä¢ MACD: ${currentAnalysis.macd?.value || 'N/A'} (${currentAnalysis.macd?.signal || 'N/A'})
‚Ä¢ Moving Average: ${currentAnalysis.movingAverage?.value || 'N/A'} (${currentAnalysis.movingAverage?.signal || 'N/A'})
‚Ä¢ VWAP: ${currentAnalysis.vwap?.value || 'N/A'} (${currentAnalysis.vwap?.signal || 'N/A'})

üìù DETAILED ANALYSIS:
${currentAnalysis.analysis || 'No detailed analysis available.'}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚ö†Ô∏è IMPORTANT DISCLAIMERS:

üö® NOT FINANCIAL ADVICE: This AI-generated analysis is for EDUCATIONAL and INFORMATIONAL purposes ONLY. It is NOT investment advice, NOT a recommendation to buy/sell, and NOT a trading signal.

‚ö†Ô∏è HIGH RISK: Trading involves substantial risk of loss. 9 out of 10 F&O traders lose money. Only trade with money you can afford to lose.

üìã SEBI NOTICE: BroBillionaire is NOT a SEBI-registered Investment Advisor or Research Analyst. Always consult a SEBI-registered professional before making investment decisions.

‚úÖ DYOR: Always Do Your Own Research and verify all information independently before trading.

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Generated by BroBillionaire.com | For Educational Purposes Only`;
            
            // Use multiple methods to ensure copy works
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text)
                    .then(() => {
                        showCopySuccess();
                    })
                    .catch((err) => {
                        console.error('Clipboard API failed:', err);
                        fallbackCopyText(text);
                    });
            } else {
                fallbackCopyText(text);
            }
        }
        
        function fallbackCopyText(text) {
            // Create a temporary textarea element
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-9999px';
            textArea.style.top = '0';
            textArea.setAttribute('readonly', '');
            document.body.appendChild(textArea);
            
            // Select and copy
            textArea.focus();
            textArea.select();
            textArea.setSelectionRange(0, text.length);
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showCopySuccess();
                } else {
                    showCopyError();
                }
            } catch (err) {
                console.error('execCommand failed:', err);
                showCopyError();
            }
            
            document.body.removeChild(textArea);
        }
        
        function showCopySuccess() {
            // Show visual feedback
            const btn = document.querySelector('.action-btn.primary');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i> Copied Successfully!';
            btn.style.background = 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)';
            
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.style.background = '';
            }, 2000);
        }
        
        function showCopyError() {
            alert('Unable to copy automatically. Please try:\n1. Press Ctrl+C (Cmd+C on Mac) after selecting the text\n2. Use the browser\'s copy function\n3. Try a different browser');
        }
        
        function newAnalysis() {
            document.getElementById('resultsSection').classList.remove('visible');
            clearImage(new Event('click'));
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function saveToJournal() {
            const history = JSON.parse(localStorage.getItem('tradeAnalysisHistory') || '[]');
            history.unshift({ id: Date.now(), signal: currentAnalysis.signal, pattern: currentAnalysis.pattern, date: new Date().toLocaleString('en-IN'), analysis: currentAnalysis });
            if (history.length > 20) history.pop();
            localStorage.setItem('tradeAnalysisHistory', JSON.stringify(history));
            alert('Saved to trading journal!');
        }
        
        function shareAnalysis() {
            if (navigator.share) {
                navigator.share({ title: 'AI Trade Setup Analysis', text: `Check out this trade setup: ${currentAnalysis.signal} signal for ${currentAnalysis.pattern}`, url: window.location.href });
            } else { copyAnalysis(); }
        }
        
        function copyLevelsOnly() {
            if (!currentAnalysis) {
                alert('No analysis to copy. Please analyze a chart first.');
                return;
            }
            
            const text = `üìç TRADE LEVELS (Educational Only)
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚Ä¢ Entry: ${currentAnalysis.entry || 'N/A'}
‚Ä¢ Target 1: ${currentAnalysis.target1 || 'N/A'}
‚Ä¢ Target 2: ${currentAnalysis.target2 || 'N/A'}
‚Ä¢ Target 3: ${currentAnalysis.target3 || 'N/A'}
‚Ä¢ Stop Loss: ${currentAnalysis.stopLoss || 'N/A'}
‚Ä¢ R:R Ratio: ${currentAnalysis.riskRewardRatio || 'N/A'}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚ö†Ô∏è NOT financial advice. For educational purposes only.`;
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text)
                    .then(() => {
                        alert('Trade levels copied to clipboard!');
                    })
                    .catch(() => {
                        fallbackCopyText(text);
                    });
            } else {
                fallbackCopyText(text);
            }
        }
        
        // Enable text selection for results section
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('calcCapital').value = document.getElementById('capitalInput').value;
            
            // Make all result values selectable
            const resultsSection = document.getElementById('resultsSection');
            if (resultsSection) {
                resultsSection.style.userSelect = 'text';
                resultsSection.style.webkitUserSelect = 'text';
            }
        });
        
        document.addEventListener('keydown', (e) => { 
            if (e.ctrlKey && e.key === 'Enter') analyzeChart(); 
            if (e.ctrlKey && e.key === 'c' && currentAnalysis) {
                // Allow default copy behavior - don't prevent it
            }
        });
    </script>
<script src="common-footer.js" defer></script>
</body>
</html>
